<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#e8f8ee">
<title>midzumi ‚Äî –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã</title>
<style>
  :root{
    --bg:#f3fbf6; --card:#ffffff; --text:#173a2b; --muted:#6b7a82; --line:#cfe9da;
    --accent:#28b487; --accent-2:#1ea97a; --ring:#a7e8c7; --success:#0f9d58; --danger:#e63946;
    --shadow:0 10px 30px rgba(22,120,86,0.12);
    --bottom-bar-height:78px;
    --topbar-height:64px;
    --maxw:480px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;color:var(--text);background:
    radial-gradient(900px 420px at 10% -10%, #d6f6e3 0%, transparent 60%), var(--bg);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  /* Centered app */
  .app{max-width:var(--maxw);margin:0 auto; padding: calc(var(--topbar-height) + 14px) 12px calc(env(safe-area-inset-bottom) + var(--bottom-bar-height) + 20px);}
  @media (min-width:500px){ .app{padding-left:16px;padding-right:16px} }

  /* Fixed dynamic topbar (only logo + name) */
  .topbar{position:fixed;top:0;left:0;right:0;height:var(--topbar-height);
    display:flex;align-items:center;justify-content:center;
    padding:8px 12px;background:linear-gradient(180deg,#f3fbf6 70%,#f3fbf600);
    z-index:1200;backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid #e9f7ef80;}
  .logo{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:14px;
    background:linear-gradient(180deg,#eafaf1,#dff6eb);border:1px solid var(--line);
    box-shadow:var(--shadow); transform-origin:50% 0%; transition:transform .2s ease}
  .logo.shrink{transform:scale(.92)}
  .mark{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;
    color:#fff;font-weight:900;background:linear-gradient(180deg,#2fd39c,#1ea97a);font-size:18px}
  .name{font-weight:900;color:#1e7156}

  /* Section headings */
  .h1{font-size:22px;font-weight:900;color:#0f5132;text-align:center;margin:6px 0 14px}

  /* Horizontal category buttons (no emoji) */
  .cats{display:flex;gap:8px; margin:6px 0 10px}
  .cat-btn{flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
    background:linear-gradient(180deg,#f6fffa,#e9fbf1); color:#145c48; font-weight:900; cursor:pointer;
    box-shadow:var(--shadow); transition:transform .05s ease}
  .cat-btn:active{transform:translateY(1px)}
  .cat-btn.active{box-shadow:0 0 0 4px var(--ring), var(--shadow);}

  /* Grid 3x3 */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:360px){.grid{grid-template-columns:repeat(2,1fr)}}
  .item{background:var(--card);border-radius:12px;border:1px solid var(--line);
    overflow:hidden;cursor:pointer;box-shadow:var(--shadow);display:flex;flex-direction:column}
  .item .img-wrap{position:relative}
  .item img{width:100%;height:100%;aspect-ratio:1/1;object-fit:cover;background:#f2fff7}
  .price-tag{position:absolute;top:8px;right:8px;background:linear-gradient(180deg,#2fd39c,#1ea97a);
    color:#fff;font-weight:800;font-size:11px;padding:4px 8px;border-radius:999px;box-shadow:0 6px 14px rgba(30,169,122,.18)}
  .caption{padding:8px;font-size:12px;color:#23543e;min-height:38px}

  /* Panels */
  .panel{background:var(--card);border-radius:14px;border:1px solid var(--line);
    padding:12px;box-shadow:var(--shadow);margin:24px 0 10px}
  .panel h3{margin:0 0 10px;color:#0f5132}

  /* Basket slots ‚Äî make images dominate, show total inside */
  .slots{display:flex;gap:10px}
  .slot{flex:1 1 0;text-align:center;background:#f7fffb;border-radius:12px;border:1px dashed #cbe7d7;padding:8px}
  .slot img{width:100%;height:102px;object-fit:contain;border-radius:8px;background:#f2fff7;border:1px solid #e3f5eb}
  .slot .name{font-size:12px;margin-top:6px;color:#18593f;min-height:32px}
  .slot .price{font-weight:800;color:#1d7a5a;margin-top:3px}
  .basket-total{margin-top:8px;display:flex;justify-content:flex-end;gap:8px;align-items:center}
  .basket-total .label{color:#3a6a58}
  .basket-total .value{font-weight:900;color:#0f5132}

  /* Delivery select (fits overall design) */
  .field{display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .field label{font-size:13px;color:#2b5a47}
  select,input[type="text"]{padding:12px;border-radius:12px;border:1px solid var(--line);background:#f9fffb;font-size:14px}

  /* Promo bigger, placed after delivery and before totals */
  .promo-row{display:flex;gap:8px}
  .promo-apply{padding:12px 14px;border-radius:12px;border:1px solid #bfead6;background:#eafaf1;font-weight:900;cursor:pointer}
  .promo-feedback{margin-top:8px;display:flex;gap:8px;align-items:center;min-height:22px}
  /* FIXED: perfectly centered tick */
  .check{
    width:22px;height:22px;border-radius:50%;
    border:2px solid var(--success);
    display:none; /* will switch to grid by JS */
    position:relative;
    background:#f7fff9;
  }
  .check::after{
    content:"";
    position:absolute;
    left:50%; top:50%;
    width:7px; height:12px;
    border-right:3px solid var(--success);
    border-bottom:3px solid var(--success);
    transform:translate(-50%,-60%) rotate(45deg);
  }
  .ok{color:var(--success)} .error{color:var(--danger)}

  /* FIXED: brighter discount note while keeping style */
  .discount-title{
    font-size:13px;
    color:#145c48;
    opacity:.95;
    display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  }
  .discount-title .strong{
    font-weight:900;
    color:#0d6e50;
    background:linear-gradient(180deg,#bff3d9,#9fecc8);
    padding:2px 8px;border-radius:999px;
    box-shadow:0 0 0 1px #8fe7c280 inset;
  }

  /* Summary rows + place order */
  .summary-row{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:var(--muted)}
  .total{font-weight:900;color:#0f5132;font-size:16px}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px;width:100%;border-radius:12px;border:none;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;font-weight:900;cursor:pointer}
  .btn:active{transform:translateY(1px)}

  /* Product modal */
  .modal{display:none;position:fixed;inset:0;z-index:1400;background:rgba(0,0,0,0.45);padding:18px;display:flex;align-items:center;justify-content:center}
  .modal-content{width:min(94vw,520px);background:var(--card);border-radius:14px;padding:12px;border:1px solid var(--line);box-shadow:var(--shadow)}
  .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .modal-img-wrap{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#f2fff7}
  .modal-img{width:100%;display:block;max-height:54vh;object-fit:contain}
  .nav{position:absolute;inset:0;display:flex;align-items:center;justify-content:space-between;pointer-events:none}
  .nav button{pointer-events:auto;width:44px;height:44px;border-radius:999px;border:1px solid var(--line);background:#ffffffcc;cursor:pointer;font-size:18px}
  .dots{position:absolute;left:0;right:0;bottom:8px;display:flex;gap:6px;justify-content:center}
  .dot{width:8px;height:8px;border-radius:50%;background:#b8dfcc;border:1px solid #8fd7b8}
  .dot.active{background:#1ea97a}
  .sound-btn{margin-top:8px; display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:linear-gradient(180deg,#f6fffa,#e9fbf1); font-weight:900; color:#145c48; cursor:pointer}
  .sound-btn:active{transform:translateY(1px)}
  .modal-actions{margin-top:12px}

  /* Payment modal */
  .pay-modal{display:none;position:fixed;inset:0;z-index:1500;background:rgba(0,0,0,0.45);padding:18px;display:flex;align-items:center;justify-content:center}
  .pay-card{width:min(94vw,520px);background:var(--card);border-radius:14px;padding:12px;border:1px solid var(--line);box-shadow:var(--shadow)}
  .pay-methods{display:flex;flex-direction:column;gap:8px;margin:8px 0}
  .pay-methods label{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;border:1px solid var(--line);background:#f7fffb;cursor:pointer}
  .pay-details{margin-top:8px;padding:8px;border-radius:10px;border:1px dashed #cfe9da;background:#fbfff9;font-size:13px;color:#145c48}
  .mini-slot{flex:1;text-align:center;background:#f7fffb;border-radius:12px;border:1px dashed #cbe7d7;padding:8px}
  .mini-slot img{width:100%;height:72px;object-fit:contain;background:#f2fff7;border:1px solid #e3f5eb;border-radius:8px}

  /* Bottom nav ‚Äî fixed and always visible */
  .bottom-bar{position:fixed;left:0;right:0;bottom:0;height:var(--bottom-bar-height);z-index:1300;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#ffffffee,#f7fffb);border-top:1px solid var(--line);box-shadow:0 -10px 30px rgba(22,120,86,0.06)}
  .bottom-tabs{width:100%;max-width:var(--maxw);display:flex;gap:10px;padding:10px;box-sizing:border-box}
  .bottom-btn{flex:1;display:flex;gap:8px;align-items:center;justify-content:center;padding:10px;border-radius:12px;border:1px solid var(--line);background:linear-gradient(180deg,#f6fffa,#e9fbf1);color:#145c48;font-weight:900;cursor:pointer}
  .bottom-btn.active{box-shadow:0 0 0 4px var(--ring),var(--shadow)}

  /* Orders page block */
  .orders-list{display:flex;flex-direction:column;gap:10px}
  .order{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px}
  .order-head{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .order-items{display:flex;gap:8px;margin-top:8px}
  .order-items img{width:72px;height:72px;object-fit:contain;border-radius:8px;border:1px solid #e3f5eb;background:#f2fff7}

  /* Community (removed display:none bug) */
  .comm-tabs{display:flex;gap:8px;margin:6px 0 12px}
  .comm-btn{flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
    background:linear-gradient(180deg,#f6fffa,#e9fbf1); color:#145c48; font-weight:900; cursor:pointer; box-shadow:var(--shadow)}
  .comm-btn.active{box-shadow:0 0 0 4px var(--ring), var(--shadow);}
  /* Posts like Instagram */
  .posts{display:flex;flex-direction:column;gap:10px}
  .post{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
  .post-head{display:flex;justify-content:space-between;align-items:center;padding:10px}
  .post-img{width:100%;height:260px;object-fit:cover;background:#f2fff7;border-top:1px solid #eaf4ee;border-bottom:1px solid #eaf4ee}
  .post-actions{display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
  .like-btn{padding:8px 12px;border-radius:12px;border:1px solid #ffd1db;background:#fff0f3;font-weight:800;color:#7a1a2f;cursor:pointer}
  .like-btn.liked{background:linear-gradient(180deg,#ffcdd5,#ffb7c3); border-color:#ff8fa3; color:#7a0f26}
  .more{background:none;border:none;color:#4b7d6a;font-weight:700;cursor:pointer}
  .comp-pop{padding:10px}
  .comp-grid{display:flex;gap:10px}
  .comp-grid .mini-slot img{height:84px}

  /* Reviews */
  .reviews-list{display:flex;flex-direction:column;gap:10px}
  .review{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;box-shadow:var(--shadow)}
  .review-head{display:flex;align-items:center;gap:10px}
  .review-img{width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid #e3f5eb;background:#f2fff7;cursor:pointer}
  .stars{color:#eab308;font-weight:900}
  .muted{color:var(--muted)}

  /* Helpers */
  .hidden{display:none !important}
  .divider{height:1px;background:var(--line);margin:12px 0}

  /* iPhone 12 safe space fit */
  @supports (padding:max(0px)) {
    .topbar{padding-top: max(8px, env(safe-area-inset-top));}
    .bottom-bar{padding-bottom: max(8px, env(safe-area-inset-bottom));}
  }
</style>
</head>
<body>
  <!-- Fixed Top Bar -->
  <div class="topbar">
    <div class="logo" id="top-logo"><div class="mark">Êπñ</div><div class="name">midzumi</div></div>
  </div>

  <main class="app" id="app">
    <!-- CONFIGURATOR (this whole block hides on Orders/Community) -->
    <section id="configurator">
      <div class="h1">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã</div>

      <!-- Horizontal categories -->
      <div class="cats" role="tablist" aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏">
        <button class="cat-btn active" data-cat="bases" aria-pressed="true">–û—Å–Ω–æ–≤—ã</button>
        <button class="cat-btn" data-cat="switches" aria-pressed="false">–°–≤–∏—Ç—á–∏</button>
        <button class="cat-btn" data-cat="keycaps" aria-pressed="false">–ö–µ–π–∫–∞–ø—ã</button>
      </div>

      <!-- Grid -->
      <section id="grid" class="grid" aria-live="polite" aria-label="–°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤"></section>

      <!-- Basket -->
      <section class="panel" aria-label="–í–∞—à–∞ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è" id="basket">
        <h3>–í–∞—à–∞ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è</h3>
        <div class="slots" id="order-items">
          <div class="slot">
            <img id="order-keycap" src="" alt="–ö–µ–π–∫–∞–ø"/>
            <div class="name" id="name-keycap">–ö–µ–π–∫–∞–ø –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
            <div class="price" id="price-keycap"></div>
          </div>
          <div class="slot">
            <img id="order-switch" src="" alt="–°–≤–∏—Ç—á"/>
            <div class="name" id="name-switch">–°–≤–∏—Ç—á –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
            <div class="price" id="price-switch"></div>
          </div>
          <div class="slot">
            <img id="order-base" src="" alt="–û—Å–Ω–æ–≤–∞"/>
            <div class="name" id="name-base">–û—Å–Ω–æ–≤–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</div>
            <div class="price" id="price-base"></div>
          </div>
        </div>
        <div class="basket-total"><span class="label">–°—É–º–º–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã:</span><span class="value" id="basket-total">0 ‚ÇΩ</span></div>
      </section>

      <!-- Delivery & promo & totals -->
      <section class="panel" id="delivery-panel" aria-label="–î–æ—Å—Ç–∞–≤–∫–∞ –∏ –æ–ø–ª–∞—Ç–∞">
        <h3>–î–æ—Å—Ç–∞–≤–∫–∞ –∏ –æ–ø–ª–∞—Ç–∞</h3>

        <!-- Delivery (styled select) -->
        <div class="field">
          <label for="delivery">–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</label>
          <select id="delivery" aria-label="–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏">
            <option value="300">–°–î–≠–ö ‚Äî 300 ‚ÇΩ</option>
            <option value="500">–ö—É—Ä—å–µ—Ä ‚Äî 500 ‚ÇΩ</option>
            <option value="0">–°–∞–º–æ–≤—ã–≤–æ–∑ ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ</option>
          </select>
        </div>

        <!-- Promo (bigger, placed between delivery and totals) -->
        <div class="field">
          <label for="promo">–ü—Ä–æ–º–æ–∫–æ–¥</label>
          <div class="promo-row">
            <input id="promo" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Egomix)" autocomplete="one-time-code">
            <button id="apply-promo" class="promo-apply" aria-label="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>
          <div class="promo-feedback" id="promo-feedback">
            <span id="promo-check" class="check" aria-hidden="true"></span>
            <span id="promo-msg" class="muted"></span>
          </div>
          <div id="discount-info" style="display:none">
            <div class="discount-title"><span class="strong">–°–ö–ò–î–ö–ê 20%</span> ‚Äî –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö.</div>
          </div>
        </div>

        <!-- Totals -->
        <div style="margin-top:10px">
          <div class="summary-row"><span>–°—É–º–º–∞ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö:</span><span id="subtotal">0 ‚ÇΩ</span></div>
          <div class="summary-row" id="row-discount" style="display:none"><span>–°–∫–∏–¥–∫–∞ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É:</span><span id="discount">0 ‚ÇΩ</span></div>
          <div class="summary-row"><span>–î–æ—Å—Ç–∞–≤–∫–∞:</span><span id="shipping">0 ‚ÇΩ</span></div>
          <div class="summary-row"><span class="total">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span><span class="total" id="grand">0 ‚ÇΩ</span></div>
        </div>

        <div style="margin-top:12px"><button id="place-order" class="btn" aria-label="–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button></div>
      </section>

      <div class="divider"></div>
      <div class="muted" style="font-size:12px;text-align:center">–ü–æ–¥–¥–µ—Ä–∂–∫–∞: –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–∏—à–∏—Ç–µ <b>@midzum7</b> –≤ Telegram.</div>
    </section>

    <!-- ORDERS (only this remains visible when Orders tab is active) -->
    <section id="orders" class="hidden">
      <div class="h1">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
      <div class="orders-list" id="orders-list"></div>
    </section>

    <!-- COMMUNITY (only this remains visible when Community tab is active) -->
    <section id="community" class="hidden">
      <div class="h1">–°–æ–æ–±—â–µ—Å—Ç–≤–æ</div>
      <div class="comm-tabs" role="tablist" aria-label="–°–æ–æ–±—â–µ—Å—Ç–≤–æ">
        <button class="comm-btn active" data-tab="keyboards">–ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã</button>
        <button class="comm-btn" data-tab="reviews">–û—Ç–∑—ã–≤—ã</button>
      </div>
      <div id="community-content"></div>
    </section>
  </main>

  <!-- Product modal -->
  <div id="product-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content" role="document">
      <div class="modal-head">
        <div style="font-weight:800;color:#145c48">–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–∞</div>
        <button id="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å" style="padding:6px 8px;border-radius:10px;border:1px solid var(--line);background:#f2fff7;cursor:pointer">‚úï</button>
      </div>
      <div class="modal-img-wrap">
        <img id="modal-img" class="modal-img" src="" alt="–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞">
        <div class="nav" id="modal-nav">
          <button id="nav-left" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ">‚ùÆ</button>
          <button id="nav-right" aria-label="–°–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ">‚ùØ</button>
        </div>
        <div class="dots" id="dots"></div>
      </div>
      <div style="margin-top:10px">
        <div id="modal-price" style="font-weight:900;color:#0f5132"></div>
        <div id="modal-desc" style="color:#335c4d;margin-top:6px"></div>
        <div id="modal-extra" style="margin-top:8px;color:#1b6d53"></div>
      </div>
      <div class="modal-actions"><button id="modal-add-btn" class="btn">–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–±–æ—Ä–∫—É</button></div>
    </div>
  </div>

  <!-- Payment modal -->
  <div id="pay-modal" class="pay-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="pay-card" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:900;color:#145c48">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>
        <button id="pay-close" style="padding:6px 8px;border-radius:10px;border:1px solid var(--line);background:#f2fff7;cursor:pointer">‚úï</button>
      </div>

      <!-- Summary ‚Äî mirrors basket with totals -->
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <div class="mini-slot"><img id="pay-img-keycap" alt=""><div style="font-size:12px;color:#145c48;margin-top:4px" id="pay-name-keycap"></div></div>
        <div class="mini-slot"><img id="pay-img-switch" alt=""><div style="font-size:12px;color:#145c48;margin-top:4px" id="pay-name-switch"></div></div>
        <div class="mini-slot"><img id="pay-img-base" alt=""><div style="font-size:12px;color:#145c48;margin-top:4px" id="pay-name-base"></div></div>
      </div>

      <div style="border-top:1px solid var(--line); padding-top:8px">
        <div class="summary-row"><span>–°—É–º–º–∞ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö:</span><span id="pay-subtotal">0 ‚ÇΩ</span></div>
        <div class="summary-row" id="pay-row-discount" style="display:none"><span>–°–∫–∏–¥–∫–∞ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É:</span><span id="pay-discount">0 ‚ÇΩ</span></div>
        <div class="summary-row"><span>–°–±–æ—Ä–∫–∞:</span><span id="pay-assembly">0 ‚ÇΩ</span></div>
        <div class="summary-row"><span>–î–æ—Å—Ç–∞–≤–∫–∞:</span><span id="pay-shipping">0 ‚ÇΩ</span></div>
        <div class="summary-row"><span class="total">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span><span class="total" id="pay-total">0 ‚ÇΩ</span></div>
      </div>

      <div style="font-weight:800;color:#145c48;margin-top:8px">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</div>
      <div class="pay-methods" id="pay-methods">
        <label><input type="radio" name="pay" value="crypto" checked> –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</label>
        <label><input type="radio" name="pay" value="sbp"> –°–ë–ü</label>
        <label><input type="radio" name="pay" value="card"> –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</label>
      </div>
      <div id="pay-details" class="pay-details" style="display:none"></div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="confirm-pay" class="btn" style="flex:1">–û–ø–ª–∞—Ç–∏—Ç—å –∏ –æ—Ñ–æ—Ä–º–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Bottom navigation -->
  <div class="bottom-bar" role="navigation" aria-label="–ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
    <div class="bottom-tabs">
      <button id="tab-config" class="bottom-btn active" aria-pressed="true">üõ†Ô∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä</button>
      <button id="tab-orders" class="bottom-btn" aria-pressed="false">üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã</button>
      <button id="tab-community" class="bottom-btn" aria-pressed="false">üë§ –°–æ–æ–±—â–µ—Å—Ç–≤–æ</button>
    </div>
  </div>

<script>
/* ======================= –î–ê–ù–ù–´–ï ======================= */
const data = {
  keycaps:[
    {id:1, images:["https://i.imgur.com/8cb4LyT.jpeg","https://images.unsplash.com/photo-1604866830546-cb3b2e5b0b87?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1618365908648-e71bd5716a00?q=80&w=800&auto=format&fit=crop"], price:1200, desc:"–ö–µ–π–∫–∞–ø #1 ‚Äî PBT"},
    {id:2, images:["https://i.imgur.com/yswuUCY.jpeg","https://images.unsplash.com/photo-1606041008023-472dfb5e530f?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1605792657660-596af9009e82?q=80&w=800&auto=format&fit=crop"], price:1300, desc:"–ö–µ–π–∫–∞–ø #2 ‚Äî Cherry"},
    {id:3, images:["https://i.imgur.com/6QtIrU2.jpeg","https://images.unsplash.com/photo-1603791440384-56cd371ee9a7?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1545239351-1141bd82e8a6?q=80&w=800&auto=format&fit=crop"], price:1400, desc:"–ö–µ–π–∫–∞–ø #3 ‚Äî –º–∞—Ç–æ–≤—ã–π"},
    {id:4, images:["https://i.imgur.com/HkuASV2.jpeg","https://images.unsplash.com/photo-1587825140400-3ccd7b9e8c72?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1527443154391-507e9dc6c5cc?q=80&w=800&auto=format&fit=crop"], price:1250, desc:"–ö–µ–π–∫–∞–ø #4"},
    {id:5, images:["https://i.imgur.com/nECsM2O.jpeg","https://images.unsplash.com/photo-1600267175161-cfaa711b4a71?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1511467687858-23d96c32e4ae?q=80&w=800&auto=format&fit=crop"], price:1350, desc:"–ö–µ–π–∫–∞–ø #5"},
    {id:6, images:["https://i.imgur.com/HZVY2bv.jpeg","https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1517336714731-489689fd1ca8?q=80&w=800&auto=format&fit=crop"], price:1450, desc:"–ö–µ–π–∫–∞–ø #6"},
    {id:7, images:["https://i.imgur.com/8cb4LyT.jpeg","https://images.unsplash.com/photo-1498050108023-c5249f4df085?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1483770959832-4d43f07e6875?q=80&w=800&auto=format&fit=crop"], price:1500, desc:"–ö–µ–π–∫–∞–ø #7"},
    {id:8, images:["https://i.imgur.com/yswuUCY.jpeg","https://images.unsplash.com/photo-1505740106531-4243f3831c78?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1473093295043-cdd812d0e601?q=80&w=800&auto=format&fit=crop"], price:1100, desc:"–ö–µ–π–∫–∞–ø #8"},
    {id:9, images:["https://i.imgur.com/6QtIrU2.jpeg","https://images.unsplash.com/photo-1593508512255-86ab42a8e620?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1563986768494-4dee2763ff3f?q=80&w=800&auto=format&fit=crop"], price:1600, desc:"–ö–µ–π–∫–∞–ø #9"},
  ],
  switches:[
    {id:1, img:"https://i.imgur.com/vqPDI2L.jpeg", price:500, sound:"https://actions.google.com/sounds/v1/door/door_knock_1.ogg", desc:"–°–≤–∏—Ç—á #1"},
    {id:2, img:"https://i.imgur.com/HL6zN2i.jpeg", price:600, sound:"https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg", desc:"–°–≤–∏—Ç—á #2"},
    {id:3, img:"https://i.imgur.com/1KXQN7p.jpeg", price:550, sound:"https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg", desc:"–°–≤–∏—Ç—á #3"},
    {id:4, img:"https://i.imgur.com/v3nyRUd.jpeg", price:530, sound:"https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg", desc:"–°–≤–∏—Ç—á #4"},
    {id:5, img:"https://i.imgur.com/8PjWYbt.jpeg", price:580, sound:"https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg", desc:"–°–≤–∏—Ç—á #5"},
    {id:6, img:"https://i.imgur.com/7Erwkvk.jpeg", price:520, sound:"https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg", desc:"–°–≤–∏—Ç—á #6"},
    {id:7, img:"https://i.imgur.com/vqPDI2L.jpeg", price:540, sound:"https://actions.google.com/sounds/v1/door/door_knock_1.ogg", desc:"–°–≤–∏—Ç—á #7"},
    {id:8, img:"https://i.imgur.com/HL6zN2i.jpeg", price:610, sound:"https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg", desc:"–°–≤–∏—Ç—á #8"},
    {id:9, img:"https://i.imgur.com/1KXQN7p.jpeg", price:590, sound:"https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg", desc:"–°–≤–∏—Ç—á #9"},
  ],
  bases:[
    {id:1, images:["https://i.imgur.com/GVr4gGO.jpeg","https://images.unsplash.com/photo-1585079542156-2755d9c8affc?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1515879218367-8466d910aaa4?q=80&w=800&auto=format&fit=crop"], price:7000, material:"–ê–ª—é–º–∏–Ω–∏–π", os:"Windows, Mac", connection:"–ü—Ä–æ–≤–æ–¥–Ω–æ–µ", battery:"‚Äî", desc:"–û—Å–Ω–æ–≤–∞ #1 ‚Äî TKL"},
    {id:2, images:["https://i.imgur.com/5ltJ91F.jpeg","https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=800&auto=format&fit=crop"], price:7500, material:"–ü–ª–∞—Å—Ç–∏–∫", os:"Windows", connection:"–ë–µ—Å–ø—Ä–æ–≤–æ–¥–Ω–æ–µ", battery:"3000mAh", desc:"–û—Å–Ω–æ–≤–∞ #2 ‚Äî –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä"},
    {id:3, images:["https://i.imgur.com/2QfZGFR.jpeg","https://images.unsplash.com/photo-1555066931-4365d14bab8c?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1551033406-611cf9a28f67?q=80&w=800&auto=format&fit=crop"], price:7200, material:"–î–µ—Ä–µ–≤–æ", os:"Mac", connection:"–ü—Ä–æ–≤–æ–¥–Ω–æ–µ", battery:"‚Äî", desc:"–û—Å–Ω–æ–≤–∞ #3 ‚Äî 65%"},
    {id:4, images:["https://i.imgur.com/U5S63KY.jpeg","https://images.unsplash.com/photo-1512758017271-d7b84c2113f1?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1556157382-97eda2d62296?q=80&w=800&auto=format&fit=crop"], price:8000, material:"–ê–ª—é–º–∏–Ω–∏–π", os:"Windows, Mac", connection:"–ë–µ—Å–ø—Ä–æ–≤–æ–¥–Ω–æ–µ", battery:"4000mAh", desc:"–û—Å–Ω–æ–≤–∞ #4 ‚Äî 75%"},
    {id:5, images:["https://i.imgur.com/DtfgLjz.jpeg","https://images.unsplash.com/photo-1517433456452-f9633a875f6f?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1510915228340-29c85a43dcfe?q=80&w=800&auto=format&fit=crop"], price:6800, material:"–ü–ª–∞—Å—Ç–∏–∫", os:"Windows", connection:"–ü—Ä–æ–≤–æ–¥–Ω–æ–µ", battery:"‚Äî", desc:"–û—Å–Ω–æ–≤–∞ #5 ‚Äî –±—é–¥–∂–µ—Ç"},
    {id:6, images:["https://i.imgur.com/5kMDXpc.jpeg","https://images.unsplash.com/photo-1517694712202-14dd9538aa97?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1523475496153-3d6cc450ca68?q=80&w=800&auto=format&fit=crop"], price:6900, material:"–î–µ—Ä–µ–≤–æ", os:"Mac", connection:"–ë–µ—Å–ø—Ä–æ–≤–æ–¥–Ω–æ–µ", battery:"3500mAh", desc:"–û—Å–Ω–æ–≤–∞ #6 ‚Äî –≤–∏–Ω—Ç–∞–∂"},
    {id:7, images:["https://i.imgur.com/GVr4gGO.jpeg","https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1522075469751-3a6694fb2f61?q=80&w=800&auto=format&fit=crop"], price:7100, material:"–ê–ª—é–º–∏–Ω–∏–π", os:"Windows", connection:"–ü—Ä–æ–≤–æ–¥–Ω–æ–µ", battery:"‚Äî", desc:"–û—Å–Ω–æ–≤–∞ #7"},
    {id:8, images:["https://i.imgur.com/5ltJ91F.jpeg","https://images.unsplash.com/photo-1487014679447-9f8336841d58?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=800&auto=format&fit=crop"], price:7300, material:"–ü–ª–∞—Å—Ç–∏–∫", os:"Windows", connection:"–ë–µ—Å–ø—Ä–æ–≤–æ–¥–Ω–æ–µ", battery:"3000mAh", desc:"–û—Å–Ω–æ–≤–∞ #8"},
    {id:9, images:["https://i.imgur.com/2QfZGFR.jpeg","https://images.unsplash.com/photo-1498050108023-c5249f4df085?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1555617117-08c5fb3bfe9b?q=80&w=800&auto=format&fit=crop"], price:7050, material:"–î–µ—Ä–µ–≤–æ", os:"Mac", connection:"–ü—Ä–æ–≤–æ–¥–Ω–æ–µ", battery:"‚Äî", desc:"–û—Å–Ω–æ–≤–∞ #9"},
  ]
};
const PROMO_DB = {"Egomix":{uses:0},"SPRING20":{uses:0},"MZVIP20":{uses:0}};

/* Community seed (10 keyboards, 25 reviews total) */
const communityData = {
  posts:[
    {title:"–°–±–æ—Ä–∫–∞ #1", img:"https://images.unsplash.com/photo-1517336714731-489689fd1ca8?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[0], switch:data.switches?.[0]||{img:"",price:0,desc:""}, base:data.bases[0]}},
    {title:"–°–±–æ—Ä–∫–∞ #2", img:"https://images.unsplash.com/photo-1515879218367-8466d910aaa4?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[1], switch:data.switches?.[1]||{img:"",price:0,desc:""}, base:data.bases[1]}},
    {title:"–°–±–æ—Ä–∫–∞ #3", img:"https://images.unsplash.com/photo-1555066931-4365d14bab8c?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[2], switch:data.switches?.[2]||{img:"",price:0,desc:""}, base:data.bases[2]}},
    {title:"–°–±–æ—Ä–∫–∞ #4", img:"https://images.unsplash.com/photo-1556157382-97eda2d62296?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[3], switch:data.switches?.[3]||{img:"",price:0,desc:""}, base:data.bases[3]}},
    {title:"–°–±–æ—Ä–∫–∞ #5", img:"https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[4], switch:data.switches?.[4]||{img:"",price:0,desc:""}, base:data.bases[4]}},
    {title:"–°–±–æ—Ä–∫–∞ #6", img:"https://images.unsplash.com/photo-1512758017271-d7b84c2113f1?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[5], switch:data.switches?.[5]||{img:"",price:0,desc:""}, base:data.bases[5]}},
    {title:"–°–±–æ—Ä–∫–∞ #7", img:"https://images.unsplash.com/photo-1498050108023-c5249f4df085?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[6], switch:data.switches?.[6]||{img:"",price:0,desc:""}, base:data.bases[6]}},
    {title:"–°–±–æ—Ä–∫–∞ #8", img:"https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[7], switch:data.switches?.[7]||{img:"",price:0,desc:""}, base:data.bases[7]}},
    {title:"–°–±–æ—Ä–∫–∞ #9", img:"https://images.unsplash.com/photo-1522075469751-3a6694fb2f61?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[8], switch:data.switches?.[8]||{img:"",price:0,desc:""}, base:data.bases[8]}},
    {title:"–°–±–æ—Ä–∫–∞ #10", img:"https://images.unsplash.com/photo-1523475496153-3d6cc450ca68?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[0], switch:data.switches?.[2]||{img:"",price:0,desc:""}, base:data.bases[4]}},
  ],
  reviews:[]
};

(function seedReviews(){
  const baseReviews = [
    {r:4.8,t:'–û—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ–µ –∑–≤—É—á–∞–Ω–∏–µ –ø–æ—Å–ª–µ —Å–º–∞–∑–∫–∏, –ø–µ—á–∞—Ç–∞—Ç—å –æ–¥–Ω–æ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ.'},
    {r:4.9,t:'–î–æ—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–∞—è, —Å–æ–±—Ä–∞–ª –∑–∞ –≤–µ—á–µ—Ä. –†–µ–∫–æ–º–µ–Ω–¥—É—é!'},
    {r:4.7,t:'–ö–µ–π–∫–∞–ø—ã –Ω–µ –ø—Ä–æ—Å–≤–µ—á–∏–≤–∞—é—Ç, —à—Ä–∏—Ñ—Ç –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π, –ø—Ä–æ—Ñ–∏–ª—å —É–¥–æ–±–Ω—ã–π.'},
    {r:4.6,t:'–ù–µ–º–Ω–æ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ –≤—ã—Å–æ—Ç—ã –Ω–æ–∂–µ–∫, –Ω–æ –∫–∞—á–µ—Å—Ç–≤–æ —Ç–æ–ø.'},
    {r:5.0,t:'–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –∏ –∏–≥—Ä, —Ç–æ–ø –∑–∞ —Å–≤–æ–∏ –¥–µ–Ω—å–≥–∏.'},
  ];
  const extra = [
    {r:4.7, t:'–î–æ–ª–≥–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–ª –ø–ª–∞—Ç—ã, –≤—ã–±—Ä–∞–ª —ç—Ç—É –∏–∑-–∑–∞ —Ö–æ—Ä–æ—à–∏—Ö —Å—Ç–∞–±–æ–≤. –ó–≤—É–∫ –≥–ª—É—Ö–æ–π, –±–µ–∑ –¥—Ä–µ–±–µ–∑–≥–∞.'},
    {r:4.9, t:'–ö–æ–ª–ø–∞—á–∫–∏ —Ä–æ–≤–Ω—ã–µ, –±–µ–∑ –æ–±–ª–æ—è. –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –º—è–≥–∫–∞—è, –Ω–µ –±—å—ë—Ç –≤ –≥–ª–∞–∑–∞.'},
    {r:5.0, t:'–°–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ –±–µ–∑ —Å—é—Ä–ø—Ä–∏–∑–æ–≤. –í—Å–µ –≤–∏–Ω—Ç—ã –∏ —Ä–µ–∑—å–±—ã –≤ –ø–æ—Ä—è–¥–∫–µ.'},
    {r:4.6, t:'–°–≤–∏—Ç—á–∏ —É–ø–∞–∫–æ–≤–∞–Ω—ã –æ—Ç–ª–∏—á–Ω–æ. –•–æ—Ç–µ–ª–æ—Å—å –±—ã –±–æ–ª—å—à–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—Ä—É–∂–∏–Ω –ø–æ –∂—ë—Å—Ç–∫–æ—Å—Ç–∏.'},
    {r:4.8, t:'75% ‚Äî –ª—É—á—à–∏–π —Ñ–æ—Ä–º-—Ñ–∞–∫—Ç–æ—Ä. –î–æ–±–∞–≤–∏–ª –ø–æ—Ä–æ–ª–æ–Ω ‚Äî —Å—Ç–∞–ª–æ —Ç–∏—à–µ.'},
    {r:4.5, t:'PBT —Ç–µ–∫—Å—Ç—É—Ä–∞ —Ü–µ–ø–∫–∞—è, –ø–µ—á–∞—Ç–∞—Ç—å –ø—Ä–∏—è—Ç–Ω–æ. –¶–≤–µ—Ç –±–ª–∏–∂–µ –∫ –º–æ–ª–æ—á–Ω–æ–º—É ‚Äî –º–Ω–µ –∑–∞—à–ª–æ.'},
    {r:4.9, t:'–ú–∞–≥–∞–∑–∏–Ω –æ—Ç–≤–µ—Ç–∏–ª –≤ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å, –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ.'},
    {r:4.7, t:'–ö–ª–∏–∫ –º—è–≥–∫–∏–π, –±–µ–∑ –∑–≤–æ–Ω–∞. –°–∫–æ—Ä–æ—Å—Ç—å –Ω–∞–±–æ—Ä–∞ –≤—ã—Ä–æ—Å–ª–∞ —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é.'},
    {r:4.8, t:'–¢–∏—Ö–∏–µ –ª–∏–Ω–µ–π–∫–∏ –¥–ª—è –æ—Ñ–∏—Å–∞. –ö–æ–ª–ª–µ–≥–∏ –±–ª–∞–≥–æ–¥–∞—Ä—è—Ç :)'},
    {r:4.6, t:'–ù–∞ Mac –≤—Å—ë –æ–ø—Ä–µ–¥–µ–ª–∏–ª–æ—Å—å —Å—Ä–∞–∑—É. –•–æ—Ç–µ–ª–æ—Å—å –±—ã –±–æ–ª—å—à–µ —Å—Ö–µ–º –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.'},
    {r:4.9, t:'–ü–æ—Å–ª–µ –º–µ–º–±—Ä–∞–Ω–∫–∏ –±—É–¥—Ç–æ –ø–µ—Ä–µ—Å–µ–ª –∏–∑ –∞–≤—Ç–æ–±—É—Å–∞ –≤ —Å–ø–æ—Ä—Ç–∫–∞—Ä.'},
    {r:5.0, t:'–ù–∏–∑–∫–æ–ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–µ –∫–∞–ø—ã ‚Äî –ø–∞–ª—å—Ü—ã –º–µ–Ω—å—à–µ —É—Å—Ç–∞—é—Ç.'},
    {r:4.7, t:'–ü—Ä–æ–∫–ª–∞–¥–∫–∏ –º–µ–∂–¥—É –ø–ª–∞—Ç–æ–π –∏ –∫–æ—Ä–ø—É—Å–æ–º —É–ª—É—á—à–∏–ª–∏ –∑–≤—É–∫. –ü—Ä–æ—Å—Ç–æ—Ä –¥–ª—è –º–æ–¥–æ–≤ –æ—Ç–ª–∏—á–Ω—ã–π.'},
    {r:4.8, t:'–¢–µ–∫—Å—Ç—É—Ä–∞ –Ω–µ —Å–∫–æ–ª—å–∑–∏—Ç –ª–µ—Ç–æ–º. –†—É—Å—Å–∫–∞—è –ª–µ–≥–µ–Ω–¥–∞ –∞–∫–∫—É—Ä–∞—Ç–Ω–∞—è.'},
    {r:4.9, t:'–°–î–≠–ö –ø—Ä–∏–≤—ë–∑ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å, —Ç—Ä–µ–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–ª—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ.'},
    {r:4.6, t:'–î–∞—Ä–∏–ª –¥—Ä—É–≥—É ‚Äî –æ—Å—Ç–∞–ª—Å—è –≤ –≤–æ—Å—Ç–æ—Ä–≥–µ. –ö–∞–±–µ–ª—å –∫–æ—Ä–æ—Ç–∫–æ–≤–∞—Ç, –Ω–æ —Ä–µ—à–∞–µ–º–æ.'},
    {r:4.8, t:'–õ–∏–Ω–µ–π–Ω—ã–µ —Å–≤–∏—Ç—á–∏ —Ä–æ–≤–Ω—ã–µ, –ø–æ—Å–ª–µ –∫–∞–ø–ª–∏ —Å–º–∞–∑–∫–∏ ‚Äî —à—ë–ª–∫.'},
    {r:4.9, t:'–ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–∞—è, –±–µ–ª—ã–π –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –±–µ–ª—ã–π.'},
    {r:4.7, t:'–°—Ç–∞–±—ã –∏–∑ –∫–æ—Ä–æ–±–∫–∏ –æ–∫, –ø–æ—Å–ª–µ –±–∞–Ω–¥–∞–∂–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Å–Ω—è.'},
    {r:4.5, t:'–° –∫–ª–∏–ø—Å–∞–º–∏ –ø–æ–≤–æ–∑–∏–ª—Å—è, –Ω–æ –∏—Ç–æ–≥ –æ—Ç–ª–∏—á–Ω—ã–π. –†–µ–∫–æ–º–µ–Ω–¥—É—é.'}
  ];
  const all = baseReviews.concat(extra); // 25
  for(let i=0;i<all.length;i++){
    const p = communityData.posts[i%communityData.posts.length];
    communityData.reviews.push({img:p.img, rating:all[i].r, text:all[i].t});
  }
})();

function rndLikes(){ return Math.floor(120 + Math.random()*900); }

/* ======================= –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ======================= */
let currentCategory='bases';
let order = { keycap:null, switch:null, base:null, deliveryCost:300, paymentMethod:'crypto', promoCode:null };
const IS_ADMIN = /\badmin=1\b/.test(location.search);

/* ======================= DOM ======================= */
const gridBlock = document.getElementById('grid');
const catBtns = document.querySelectorAll('.cat-btn');

const orderImgs = { keycap:document.getElementById('order-keycap'), switch:document.getElementById('order-switch'), base:document.getElementById('order-base') };
const orderNames = { keycap:document.getElementById('name-keycap'), switch:document.getElementById('name-switch'), base:document.getElementById('name-base') };
const orderPrices = { keycap:document.getElementById('price-keycap'), switch:document.getElementById('price-switch'), base:document.getElementById('price-base') };
const basketTotalEl = document.getElementById('basket-total');

const subtotalEl = document.getElementById('subtotal'), discountEl=document.getElementById('discount'), rowDiscount=document.getElementById('row-discount');
const shippingEl=document.getElementById('shipping'), grandEl=document.getElementById('grand');
const deliverySelect=document.getElementById('delivery'), placeOrderBtn=document.getElementById('place-order');

const promoInput=document.getElementById('promo'), promoApply=document.getElementById('apply-promo'), promoMsg=document.getElementById('promo-msg'), promoCheck=document.getElementById('promo-check');
const discountInfo=document.getElementById('discount-info');

const modal=document.getElementById('product-modal'), modalImg=document.getElementById('modal-img'), modalPrice=document.getElementById('modal-price'), modalDesc=document.getElementById('modal-desc'), modalExtra=document.getElementById('modal-extra');
const modalAddBtn=document.getElementById('modal-add-btn'), modalClose=document.getElementById('modal-close'), navLeft=document.getElementById('nav-left'), navRight=document.getElementById('nav-right'), dots=document.getElementById('dots'), modalNav=document.getElementById('modal-nav');

const payModal=document.getElementById('pay-modal'), payClose=document.getElementById('pay-close'), payMethods=document.getElementById('pay-methods'), payDetails=document.getElementById('pay-details'), confirmPay=document.getElementById('confirm-pay');
const payImgK=document.getElementById('pay-img-keycap'), payImgS=document.getElementById('pay-img-switch'), payImgB=document.getElementById('pay-img-base');
const payNameK=document.getElementById('pay-name-keycap'), payNameS=document.getElementById('pay-name-switch'), payNameB=document.getElementById('pay-name-base');
const paySub=document.getElementById('pay-subtotal'), payDisc=document.getElementById('pay-discount'), payShip=document.getElementById('pay-shipping'), payTotal=document.getElementById('pay-total'), payRowDisc=document.getElementById('pay-row-discount'), payAssembly=document.getElementById('pay-assembly');

const tabConfig=document.getElementById('tab-config'), tabOrders=document.getElementById('tab-orders'), tabCommunity=document.getElementById('tab-community');
const secConfigurator=document.getElementById('configurator'), secOrders=document.getElementById('orders'), secCommunity=document.getElementById('community');

const ordersList=document.getElementById('orders-list');

const topLogo=document.getElementById('top-logo');

/* ======================= –ü–†–û–ú–û ======================= */
(function restorePromoUses(){ try{ const saved=JSON.parse(localStorage.getItem('promoUsage')||'{}'); Object.keys(PROMO_DB).forEach(k=>PROMO_DB[k].uses=saved[k]||0); }catch(e){} })();
function savePromoUsage(){ const obj={}; Object.keys(PROMO_DB).forEach(k=>obj[k]=PROMO_DB[k].uses); localStorage.setItem('promoUsage', JSON.stringify(obj)); }

/* ======================= –†–ï–ù–î–ï–† –°–ï–¢–ö–ò ======================= */
function renderGrid(cat){
  currentCategory = cat;
  gridBlock.innerHTML = '';
  const list = (data[cat] || []).slice(0,9);
  list.forEach(item=>{
    const tile = document.createElement('div');
    tile.className = 'item';
    const imgSrc = item.images ? item.images[0] : (item.img || '');
    tile.innerHTML = `<div class="img-wrap">
        <img src="${escapeHtml(imgSrc)}" alt="${escapeHtml(item.desc||'')}"/>
        <div class="price-tag">${item.price.toLocaleString('ru-RU')} ‚ÇΩ</div>
      </div>
      <div class="caption">${escapeHtml(item.desc||'')}</div>`;
    tile.addEventListener('click', ()=> openModal(item, cat));
    gridBlock.appendChild(tile);
  });
  catBtns.forEach(b=>{
    const is = b.dataset.cat === cat;
    b.classList.toggle('active', is);
    b.setAttribute('aria-pressed', is ? 'true' : 'false');
  });
}

/* ======================= –ú–û–î–ê–õ –¢–û–í–ê–†–ê ======================= */
let currentItem=null, currentImages=[], currentIndex=0;
function openModal(item, category){
  currentItem = item;
  currentImages = item.images ? item.images.slice(0,3) : (item.img ? [item.img] : []);
  currentIndex = 0;

  // For switches: no carousel (single image, hide nav & dots)
  const isSwitch = (category === 'switches');
  const imgs = isSwitch ? [ item.img ] : currentImages;

  modalImg.src = imgs[0] || '';
  modalPrice.textContent = `–¶–µ–Ω–∞: ${item.price.toLocaleString('ru-RU')} ‚ÇΩ`;
  modalDesc.textContent = item.desc || '';
  modalExtra.innerHTML = '';

  if(category === 'bases'){
    modalExtra.innerHTML = `<div><b>–ú–∞—Ç–µ—Ä–∏–∞–ª:</b> ${item.material}</div><div><b>–û–°:</b> ${item.os}</div><div><b>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:</b> ${item.connection}</div><div><b>–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä:</b> ${item.battery}</div>`;
  }
  if(category === 'switches' && item.sound){
    const b = document.createElement('button'); b.className='sound-btn'; b.innerHTML='üîä –ü—Ä–æ—Å–ª—É—à–∞—Ç—å –∑–≤—É–∫';
    b.addEventListener('click', ()=> new Audio(item.sound).play());
    modalExtra.appendChild(b);
  }

  // carousel state
  dots.innerHTML = '';
  if(isSwitch){
    modalNav.style.display='none';
  } else {
    modalNav.style.display = (imgs.length>1) ? '' : 'none';
    imgs.forEach((_,i)=> {
      const d = document.createElement('div'); d.className='dot'+(i===0?' active':''); dots.appendChild(d);
    });
  }

  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');

  modalAddBtn.onclick = ()=>{
    if(currentCategory === 'keycaps') order.keycap = currentItem;
    if(currentCategory === 'switches') order.switch = currentItem;
    if(currentCategory === 'bases') order.base = currentItem;
    persistDraft(); updateOrderView(); closeModal();
  };

  // nav
  navLeft.onclick = ()=> {
    if(isSwitch || imgs.length<=1) return;
    currentIndex=(currentIndex-1+imgs.length)%imgs.length; modalImg.src = imgs[currentIndex]; syncDots();
  };
  navRight.onclick = ()=> {
    if(isSwitch || imgs.length<=1) return;
    currentIndex=(currentIndex+1)%imgs.length; modalImg.src = imgs[currentIndex]; syncDots();
  };
  function syncDots(){
    [...dots.children].forEach((d,i)=> d.classList.toggle('active', i===currentIndex));
  }
}
function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
modalClose.addEventListener('click', closeModal);
window.addEventListener('click', e=> { if(e.target === modal) closeModal(); });
window.addEventListener('keydown', e => { if(modal.style.display === 'flex'){ if(e.key==='Escape') closeModal(); if(e.key==='ArrowLeft') navLeft.click(); if(e.key==='ArrowRight') navRight.click(); } });

/* ======================= –ü–†–û–ú–û–ö–û–î ======================= */
function applyPromo(code){
  const c = (code||'').trim();
  promoCheck.style.display = 'none'; promoMsg.textContent=''; promoMsg.className='muted';
  discountInfo.style.display = 'none'; rowDiscount.style.display = 'none';
  if(!c){ promoMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥'; promoMsg.classList.add('error'); return; }
  if(PROMO_DB[c]){
    order.promoCode = c; PROMO_DB[c].uses += 1; savePromoUsage();
    promoCheck.style.display = 'grid'; /* will show perfectly centered tick */
    promoMsg.textContent = `–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω: ${c}`; promoMsg.classList.add('ok');
    discountInfo.style.display = 'block'; rowDiscount.style.display = 'flex';
    persistDraft(); updateOrderView();
  } else {
    order.promoCode = null; promoMsg.textContent = '–¢–∞–∫–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'; promoMsg.classList.add('error'); persistDraft(); updateOrderView();
  }
}
promoApply.addEventListener('click', ()=> applyPromo(promoInput.value));
promoInput.addEventListener('keydown', e => { if(e.key === 'Enter') applyPromo(promoInput.value); });

/* ======================= –ë–û–ö–û–í–´–ï –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ======================= */
function calcSubtotal(){ return (order.keycap?.price||0) + (order.switch?.price||0) + (order.base?.price||0); }
function calcDiscount(subtotal){ return order.promoCode && PROMO_DB[order.promoCode] ? Math.round(subtotal * 0.20) : 0; }

function updateOrderView(){
  orderImgs.keycap.src = order.keycap ? (order.keycap.images ? order.keycap.images[0] : order.keycap.img) : '';
  orderImgs.switch.src = order.switch ? order.switch.img : '';
  orderImgs.base.src = order.base ? (order.base.images ? order.base.images[0] : order.base.img) : '';

  orderNames.keycap.textContent = order.keycap ? order.keycap.desc : '–ö–µ–π–∫–∞–ø –Ω–µ –≤—ã–±—Ä–∞–Ω';
  orderNames.switch.textContent = order.switch ? order.switch.desc : '–°–≤–∏—Ç—á –Ω–µ –≤—ã–±—Ä–∞–Ω';
  orderNames.base.textContent = order.base ? order.base.desc : '–û—Å–Ω–æ–≤–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞';

  orderPrices.keycap.textContent = order.keycap ? `${order.keycap.price.toLocaleString('ru-RU')} ‚ÇΩ` : '';
  orderPrices.switch.textContent = order.switch ? `${order.switch.price.toLocaleString('ru-RU')} ‚ÇΩ` : '';
  orderPrices.base.textContent = order.base ? `${order.base.price.toLocaleString('ru-RU')} ‚ÇΩ` : '';

  const subtotal = calcSubtotal();
  const discount = calcDiscount(subtotal);
  const shipping = Number(order.deliveryCost||0);
  const grand = Math.max(0, subtotal - discount) + shipping;

  subtotalEl.textContent = `${subtotal.toLocaleString('ru-RU')} ‚ÇΩ`;
  discountEl.textContent = `‚àí${discount.toLocaleString('ru-RU')} ‚ÇΩ`;
  shippingEl.textContent = `${shipping.toLocaleString('ru-RU')} ‚ÇΩ`;
  grandEl.textContent = `${grand.toLocaleString('ru-RU')} ‚ÇΩ`;
  basketTotalEl.textContent = `${(Math.max(0, subtotal - discount)).toLocaleString('ru-RU')} ‚ÇΩ`;

  // discount UI
  if(order.promoCode && PROMO_DB[order.promoCode]){
    promoCheck.style.display='grid';
    promoMsg.textContent = `–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω: ${order.promoCode}`;
    promoMsg.classList.add('ok');
    discountInfo.style.display='block';
    rowDiscount.style.display='flex';
  } else {
    promoCheck.style.display='none';
    discountInfo.style.display='none';
    rowDiscount.style.display='none';
  }
}

/* ======================= PERSISTENCE ======================= */
const ORDERS_KEY = 'midzumi_orders';
function loadOrders(){ try{ return JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]'); }catch(e){ return []; } }
function saveOrders(list){ localStorage.setItem(ORDERS_KEY, JSON.stringify(list)); }

function persistDraft(){ localStorage.setItem('midzumi_draft', JSON.stringify(order)); }
(function restoreDraft(){
  try{
    const d = JSON.parse(localStorage.getItem('midzumi_draft')||'null'); if(!d) return;
    order = Object.assign(order, d);
    if(order.promoCode && PROMO_DB[order.promoCode]){ promoCheck.style.display='grid'; promoMsg.textContent = `–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω: ${order.promoCode}`; promoMsg.classList.add('ok'); discountInfo.style.display='block'; rowDiscount.style.display='flex'; }
    if(order.deliveryCost!=null) deliverySelect.value = String(order.deliveryCost);
  }catch(e){}
})();

/* ======================= –û–ü–õ–ê–¢–ê ======================= */
function openPay(){
  if(!order.keycap || !order.switch || !order.base){ alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤—É, —Å–≤–∏—Ç—á–∏ –∏ –∫–µ–π–∫–∞–ø—ã –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º.'); return; }
  const subtotal = calcSubtotal();
  const discount = calcDiscount(subtotal);
  const shipping = Number(order.deliveryCost||0);
  const total = Math.max(0, subtotal - discount) + shipping;

  // mirror items
  payImgK.src = order.keycap?.images?.[0] || order.keycap?.img || '';
  payImgS.src = order.switch?.img || '';
  payImgB.src = order.base?.images?.[0] || order.base?.img || '';
  payNameK.textContent = order.keycap?.desc || '–ö–µ–π–∫–∞–ø';
  payNameS.textContent = order.switch?.desc || '–°–≤–∏—Ç—á';
  payNameB.textContent = order.base?.desc || '–û—Å–Ω–æ–≤–∞';

  paySub.textContent = `${subtotal.toLocaleString('ru-RU')} ‚ÇΩ`;
  payDisc.textContent = `‚àí${discount.toLocaleString('ru-RU')} ‚ÇΩ`;
  payRowDisc.style.display = discount>0 ? '' : 'none';
  payShip.textContent = `${shipping.toLocaleString('ru-RU')} ‚ÇΩ`;
  payAssembly.textContent = `0 ‚ÇΩ`;
  payTotal.textContent = `${total.toLocaleString('ru-RU')} ‚ÇΩ`;

  // methods + details
  const radios = payMethods.querySelectorAll('input[name="pay"]');
  radios.forEach(r => r.checked = (r.value === order.paymentMethod));
  updatePayDetails();

  payModal.style.display='flex'; payModal.setAttribute('aria-hidden','false');
}
function closePay(){ payModal.style.display='none'; payModal.setAttribute('aria-hidden','true'); }
payClose.addEventListener('click', closePay);
payMethods.addEventListener('change', updatePayDetails);
function updatePayDetails(){
  const sel = payMethods.querySelector('input[name="pay"]:checked');
  const v = sel ? sel.value : 'crypto';
  order.paymentMethod = v;
  persistDraft();
  let html = '';
  if(v === 'crypto'){
    html = '<b>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞)</b><div style="margin-top:6px">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—É–º–º—É. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ ¬´–û–ø–ª–∞—Ç–∏—Ç—å –∏ –æ—Ñ–æ—Ä–º–∏—Ç—å¬ª. (–¥–µ–º–æ)</div>';
  } else if(v === 'sbp'){
    html = '<b>–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –°–ë–ü</b><div style="margin-top:6px">–û—Ç–∫—Ä–æ–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ ¬´–û–ø–ª–∞—Ç–∏—Ç—å –∏ –æ—Ñ–æ—Ä–º–∏—Ç—å¬ª.</div>';
  } else {
    html = '<b>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</b><div style="margin-top:6px">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –Ω–∞ –∑–∞—â–∏—â—ë–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–¥–µ–º–æ). –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω.</div>';
  }
  payDetails.style.display = 'block';
  payDetails.innerHTML = html;
}

confirmPay.addEventListener('click', ()=>{
  const subtotal = calcSubtotal(), discount = calcDiscount(subtotal), shipping = Number(order.deliveryCost||0);
  const total = Math.max(0, subtotal - discount) + shipping;
  const newOrder = {
    id: 'MZ-' + Date.now(),
    createdAt: new Date().toISOString(),
    items: { keycap: order.keycap, switch: order.switch, base: order.base },
    pricing: { subtotal, discount, shipping, assembly:0, total, promo: order.promoCode || null },
    payment: order.paymentMethod, status: '–û–∂–∏–¥–∞–µ—Ç —Å–±–æ—Ä–∫–∏', shipDate: null
  };
  const arr = loadOrders(); arr.unshift(newOrder); saveOrders(arr);
  // reset current basket
  order.keycap = order.switch = order.base = null;
  persistDraft(); updateOrderView(); closePay();
  // Switch to Orders tab to show result
  activateTab('orders');
});

/* ======================= –ó–ê–ö–ê–ó–´ –†–ï–ù–î–ï–† ======================= */
function renderOrders(){
  const list = loadOrders();
  ordersList.innerHTML = '';
  if(list.length === 0){
    ordersList.innerHTML = '<div class="muted" style="text-align:center">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>';
    return;
  }
  list.forEach(o=>{
    const el = document.createElement('div'); el.className='order';
    el.innerHTML = `
      <div class="order-head">
        <div><b>${escapeHtml(o.id)}</b> ¬∑ <span class="muted">${new Date(o.createdAt).toLocaleString('ru-RU')}</span></div>
        <div style="background:#eafaf1;padding:6px 8px;border-radius:999px;border:1px solid #bfead6">${escapeHtml(o.status)}${o.shipDate?(' ¬∑ –æ—Ç–ø—Ä–∞–≤–∫–∞: '+new Date(o.shipDate).toLocaleDateString('ru-RU')):''}</div>
      </div>
      <div class="order-items">
        <img src="${o.items.keycap?.images?.[0] || o.items.keycap?.img || ''}">
        <img src="${o.items.switch?.img || ''}">
        <img src="${o.items.base?.images?.[0] || o.items.base?.img || ''}">
      </div>
      <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
        <div class="muted">–ò—Ç–æ–≥–æ:</div>
        <div style="font-weight:900">${(o.pricing.total||0).toLocaleString('ru-RU')} ‚ÇΩ</div>
      </div>
    `;
    ordersList.appendChild(el);
  });
}

/* ======================= COMMUNITY RENDER ======================= */
const commTabs = document.querySelectorAll('.comm-btn');
const commContent = document.getElementById('community-content');

commTabs.forEach(b=> b.addEventListener('click', ()=>{
  commTabs.forEach(x=> x.classList.toggle('active', x===b));
  showCommunity(b.dataset.tab);
}));

function showCommunity(tab){
  commContent.innerHTML = '';
  if(tab==='keyboards'){
    const wrap = document.createElement('div'); wrap.className='posts';
    communityData.posts.forEach(p=>{
      const post = document.createElement('div'); post.className='post';
      post.innerHTML = `
        <div class="post-head"><div>${escapeHtml(p.title)}</div>
          <button class="more">‚ãØ</button></div>
        <img class="post-img" src="${p.img}" alt="${escapeHtml(p.title)}"/>
        <div class="post-actions">
          <button class="like-btn ${p.liked?'liked':''}">–ù—Ä–∞–≤–∏—Ç—Å—è</button>
          <div>${p.likes.toLocaleString('ru-RU')} ‚ô•</div>
        </div>
      `;
      // like toggle (+1 / -1)
      const btn = post.querySelector('.like-btn');
      const counter = post.querySelector('.post-actions div');
      btn.addEventListener('click', ()=>{
        p.liked = !p.liked;
        if(p.liked){ p.likes += 1; btn.classList.add('liked'); }
        else{ p.likes = Math.max(0, p.likes-1); btn.classList.remove('liked'); }
        counter.textContent = `${p.likes.toLocaleString('ru-RU')} ‚ô•`;
      });

      // 3-dots -> show components pop
      post.querySelector('.more').addEventListener('click', ()=>{
        const box = document.createElement('div');
        box.className='comp-pop';
        box.innerHTML = `<div style="font-weight:800;color:#145c48;margin-bottom:6px">–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ</div>
        <div class="comp-grid">
          <div class="mini-slot"><img src="${p.items.keycap?.images?.[0] || p.items.keycap?.img || ''}"><div style="font-size:12px;margin-top:4px">${escapeHtml(p.items.keycap?.desc||'')}</div></div>
          <div class="mini-slot"><img src="${p.items.switch?.img || ''}"><div style="font-size:12px;margin-top:4px">${escapeHtml(p.items.switch?.desc||'')}</div></div>
          <div class="mini-slot"><img src="${p.items.base?.images?.[0] || p.items.base?.img || ''}"><div style="font-size:12px;margin-top:4px">${escapeHtml(p.items.base?.desc||'')}</div></div>
        </div>`;
        post.appendChild(box);
        post.querySelector('.more').disabled = true;
      });

      wrap.appendChild(post);
    });
    commContent.appendChild(wrap);
  } else {
    const list = document.createElement('div'); list.className='reviews-list';
    communityData.reviews.forEach(r=>{
      const card = document.createElement('div'); card.className='review';
      card.innerHTML = `
        <div class="review-head">
          <img class="review-img" src="${r.img}" alt="–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞">
          <div><div class="stars">‚òÖ ${r.rating.toFixed(1)} / 5</div></div>
        </div>
        <div style="margin-top:8px">${escapeHtml(r.text)}</div>
      `;
      // click on image -> show components of related post
      const img = card.querySelector('.review-img');
      img.addEventListener('click', ()=>{
        const p = communityData.posts.find(x=>x.img===r.img);
        if(!p) return;
        openComponentsQuick(p);
      });
      list.appendChild(card);
    });
    const note = document.createElement('div'); note.className='muted'; note.style.marginTop='6px';
    note.textContent = '–û—Ç–∑—ã–≤—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ @midzum7 –≤ Telegram.';
    list.appendChild(note);

    commContent.appendChild(list);
  }
}

function openComponentsQuick(p){
  modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
  modalImg.src = p.img;
  modalPrice.textContent = '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ';
  modalDesc.textContent = p.title;
  modalExtra.innerHTML = `
    <div style="display:flex;gap:10px;margin-top:6px">
      <div class="mini-slot"><img src="${p.items.keycap?.images?.[0] || p.items.keycap?.img || ''}"><div style="font-size:12px;margin-top:4px">${escapeHtml(p.items.keycap?.desc||'')}</div></div>
      <div class="mini-slot"><img src="${p.items.switch?.img || ''}"><div style="font-size:12px;margin-top:4px">${escapeHtml(p.items.switch?.desc||'')}</div></div>
      <div class="mini-slot"><img src="${p.items.base?.images?.[0] || p.items.base?.img || ''}"><div style="font-size:12px;margin-top:4px">${escapeHtml(p.items.base?.desc||'')}</div></div>
    </div>`;
  modalNav.style.display='none'; dots.innerHTML='';
  modalAddBtn.onclick = ()=>{};
}

/* ======================= –¢–ê–ë–´ –ù–ò–ñ–ù–ï–ô –ù–ê–í–ò–ì–ê–¶–ò–ò ======================= */
tabConfig.addEventListener('click', ()=> activateTab('config'));
tabOrders.addEventListener('click', ()=> activateTab('orders'));
tabCommunity.addEventListener('click', ()=> activateTab('community'));

function activateTab(name){
  [tabConfig,tabOrders,tabCommunity].forEach(b=>b.classList.remove('active'));
  secConfigurator.classList.add('hidden');
  secOrders.classList.add('hidden');
  secCommunity.classList.add('hidden');

  if(name==='config'){
    tabConfig.classList.add('active');
    secConfigurator.classList.remove('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  } else if(name==='orders'){
    tabOrders.classList.add('active');
    secOrders.classList.remove('hidden');
    renderOrders();
    window.scrollTo({top:0,behavior:'smooth'});
  } else {
    tabCommunity.classList.add('active');
    secCommunity.classList.remove('hidden'); // FIXED: community now shows (no display:none class conflict)
    if(!secCommunity.dataset.inited){
      showCommunity('keyboards');
      secCommunity.dataset.inited='1';
    }
    window.scrollTo({top:0,behavior:'smooth'});
  }
}

/* ======================= –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ======================= */
deliverySelect.addEventListener('change', (e) => { order.deliveryCost = Number(e.target.value||0); persistDraft(); updateOrderView(); });
placeOrderBtn.addEventListener('click', openPay);
catBtns.forEach(b => b.addEventListener('click', ()=> renderGrid(b.dataset.cat)));

/* ======================= –¢–û–ü–ë–ê–† –î–ò–ù–ê–ú–ò–ö–ê ======================= */
(function dynamicTopbar(){
  let lastY = 0;
  window.addEventListener('scroll', ()=>{
    const y = window.scrollY || 0;
    if(y>8 && lastY<=8) topLogo.classList.add('shrink');
    if(y<=8 && lastY>8) topLogo.classList.remove('shrink');
    lastY = y;
  }, {passive:true});
})();

/* ======================= INIT ======================= */
(function init(){
  renderGrid(currentCategory);
  updateOrderView();
})();

/* ======================= –£–¢–ò–õ–´ ======================= */
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
</script>
</body>
</html>
