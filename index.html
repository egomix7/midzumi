<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#e8f8ee" />
<title>midzumi — Конфигуратор клавиатуры</title>
<style>
  :root{
    /* Светлая зелёная тема */
    --bg: #f3fbf6;
    --bg-2:#e8f8ee;
    --card:#ffffff;
    --text:#1f2937;
    --muted:#5b6b73;
    --line:#cfe9da;
    --accent:#28b487;      /* кнопки */
    --accent-2:#1ea97a;    /* ховер */
    --accent-3:#b7efd3;    /* светлый фон */
    --danger:#e63946;
    --success:#0f9d58;     /* галочка */
    --ring:#a7e8c7;
    --shadow: 0 8px 28px rgba(21,114,84,.15);
  }
  *{box-sizing:border-box;}
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 10% -10%, #d6f6e3, transparent 70%),
      radial-gradient(1000px 600px at 120% 10%, #e3f8ef, transparent 70%),
      var(--bg);
    -webkit-tap-highlight-color: transparent;
    padding-bottom: max(72px, env(safe-area-inset-bottom));
  }
  .wrap{max-width:560px; margin:0 auto; padding: env(safe-area-inset-top) 12px 16px;}
  header{
    display:flex; align-items:center; justify-content:center;
    gap:8px; padding:12px 6px 8px;
  }
  .logo{
    display:flex; align-items:center; gap:10px;
    background:linear-gradient(180deg,#eafaf1,#dff6eb);
    border:1px solid var(--line);
    border-radius:16px; padding:8px 14px; box-shadow: var(--shadow);
  }
  .logo .mark{
    width:28px; height:28px; border-radius:10px; display:grid; place-items:center;
    background: radial-gradient(60% 60% at 30% 20%, #2fd39c, #1ea97a);
    color:#fff; font-weight:900; font-size:14px; letter-spacing:.2px;
    box-shadow: 0 6px 14px rgba(30,169,122,.3);
  }
  .logo .name{ font-weight:900; letter-spacing:.3px; color:#1e7156 }

  .hint{ text-align:center; color:#5f7a6a; font-size:13px; margin:4px 0 12px; }

  /* Меню категорий */
  .menu{
    display:flex; gap:10px;
  }
  .menu button{
    flex:1 1 0; display:flex; align-items:center; gap:10px;
    padding:12px 12px; border:none; cursor:pointer; border-radius:14px;
    background: linear-gradient(180deg,#f6fffa,#e9fbf1);
    border:1px solid var(--line);
    box-shadow: var(--shadow);
    transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
  }
  .menu button:active{ transform:scale(.98) }
  .menu .ic{
    width:32px; height:32px; border-radius:10px; display:grid; place-items:center;
    background: radial-gradient(70% 70% at 30% 20%, #c3f3de, #94eac6);
    color:#0e6047; font-size:18px; box-shadow: inset 0 0 0 1px #bfead6;
  }
  .menu .ttl{ font-weight:800; font-size:14px; color:#195745 }
  .menu .sub{ font-size:11px; color:#6d8f80 }

  .divider{ height:1px; background: var(--line); margin:12px 0; }

  /* Блок-сетка */
  .block{ display:none; }
  .block.active{ display:block; animation: fadeIn .2s ease }
  @keyframes fadeIn{ from{opacity:0; transform: translateY(4px)} to{opacity:1; transform:none} }

  .grid{
    display:grid; gap:10px; margin: 10px 0 2px;
    grid-template-columns: repeat(3, 1fr); /* 3 x 2 для 6 плиток */
  }
  /* При очень узких экранах позволим 2 колонки */
  @media (max-width: 360px){
    .grid{ grid-template-columns: repeat(2, 1fr); }
  }

  .item{
    position:relative; overflow:hidden; background: var(--card);
    border:1px solid var(--line); border-radius:14px; box-shadow: var(--shadow);
    cursor:pointer; transition: transform .12s ease;
  }
  .item:active{ transform: scale(.98) }
  .item img{ width:100%; aspect-ratio:1/1; object-fit:contain; background:#f2fff7; border-bottom:1px solid var(--line) }
  .price-tag{
    position:absolute; top:6px; right:6px; z-index:2;
    background:linear-gradient(180deg,#2fd39c,#1ea97a); color:#fff; font-weight:800;
    font-size:11px; padding:4px 7px; border-radius:999px; box-shadow: 0 6px 14px rgba(30,169,122,.35);
  }
  .caption{ font-size:12px; color:#264f40; padding:8px; min-height:40px }

  /* Корзина + доставка/оплата на мобильной колонкой */
  .panel{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow: var(--shadow); margin: 12px 0; }
  .panel h3{ margin:2px 0 10px; font-size:16px; color:#155e49; letter-spacing:.2px }

  #order-items{ display:flex; gap:8px; }
  .slot{ flex:1 1 0; text-align:center; border:1px dashed #cbe7d7; border-radius:12px; padding:8px; background: #f7fffb }
  .slot img{ width:100%; height:90px; object-fit:contain; background:#f2fff7; border:1px solid #e3f5eb; border-radius:10px }
  .slot .name{ margin-top:6px; font-size:12px; color:#2a5f4b }
  .slot .price{ margin-top:2px; font-weight:800; color:#1d7a5a }

  .summary-row{ display:flex; align-items:center; justify-content:space-between; margin-top:8px; gap:8px; }
  .total{ font-weight:900; color:#0f5132; font-size:16px }
  .muted{ color:#4b7061; font-size:13px }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:12px; width:100%; border:none; border-radius:12px; cursor:pointer;
    background: linear-gradient(180deg, var(--accent), var(--accent-2)); color:#fff; font-weight:900; letter-spacing:.2px;
    box-shadow: 0 10px 20px rgba(30,169,122,.25);
  }
  .btn:active{ transform: translateY(1px) }

  .field{ margin:10px 0 }
  .field label{ display:block; margin-bottom:6px; font-size:13px; color:#1b6d53; }
  select, input[type="text"]{
    width:100%; padding:12px; border-radius:12px; border:1px solid var(--line);
    background:#f9fffb; color:#133c30; outline:none;
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  select:focus, input[type="text"]:focus{ box-shadow: 0 0 0 4px var(--ring); border-color:#7fdcb5 }
  .radios{ display:flex; gap:8px; flex-wrap:wrap; }
  .radios label{ display:flex; align-items:center; gap:6px; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#f7fffb; }
  .radios input{ accent-color:#1ea97a }

  .promo-row{ display:flex; gap:8px }
  .promo-row input{ flex:1 }
  .promo-apply{ white-space:nowrap; padding:12px 14px; border-radius:12px; border:1px solid #bfead6; background:#eafaf1; color:#18654d; font-weight:800; cursor:pointer; }
  .promo-apply:active{ transform: translateY(1px) }

  .promo-feedback{ display:flex; align-items:center; gap:8px; min-height:20px; margin-top:6px; font-size:13px }
  .check{
    width:20px; height:20px; border-radius:50%; border:2px solid var(--success); position:relative; display:none;
    animation: pop .25s ease;
  }
  .check::after{
    content:""; position:absolute; left:4px; top:2px; width:6px; height:10px; border:2px solid var(--success);
    border-top:none; border-left:none; transform: rotate(45deg);
  }
  @keyframes pop{ from{transform: scale(.6); opacity:0} to{transform: scale(1); opacity:1} }
  .error{ color: var(--danger) }
  .ok{ color: var(--success) }

  .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#eafaf1; border:1px solid #bfead6; font-size:12px; color:#175c49 }

  /* Кнопка «наверх» */
  .to-top{
    position:fixed; left:12px; bottom: calc(16px + env(safe-area-inset-bottom));
    width:44px; height:44px; border-radius:999px; border:1px solid #cbe7d7; background:#ffffffdd; backdrop-filter: blur(4px);
    display:grid; place-items:center; box-shadow: var(--shadow); cursor:pointer; z-index:999;
  }

  /* Модальное окно */
  .modal{ display:none; position:fixed; inset:0; z-index:1000; background: #00000040; backdrop-filter: blur(4px); padding:16px; }
  .modal-content{
    width:min(94vw, 520px);
    margin:0 auto; background:var(--card); border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow: var(--shadow);
  }
  .modal-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px }
  .modal-title{ font-weight:800; color:#145c48 }
  .modal-close{
    width:36px; height:36px; border-radius:10px; border:1px solid var(--line); background:#f2fff7; cursor:pointer;
  }
  .modal-img-wrap{ position:relative; overflow:hidden; border:1px solid var(--line); border-radius:12px; background:#f2fff7 }
  .modal-img{ width:100%; display:block; max-height:50vh; object-fit:contain; background:#f2fff7 }
  .nav{ position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between; pointer-events:none; }
  .nav button{ pointer-events:auto; width:40px; height:40px; border-radius:999px; border:1px solid var(--line); background:#ffffffcc; cursor:pointer }
  .modal-price{ margin:10px 0 6px; font-weight:900; color:#0f5132 }
  .modal-desc{ color:#335c4d; font-size:13px; min-height:34px }
  .modal-extra{ color:#1b6d53; font-size:13px; display:grid; gap:4px }
  .sound-btn{ margin-top:8px; padding:10px 12px; border:none; border-radius:12px; background:linear-gradient(180deg,#2fd39c,#1ea97a); color:#fff; font-weight:800; }
  .btn-add{ margin-top:10px; width:100%; padding:12px; border:none; border-radius:12px; background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#fff; font-weight:900; }

  /* Мои заказы */
  .order{
    border:1px solid var(--line); border-radius:12px; background:#fff; padding:10px; margin:8px 0;
  }
  .order-head{ display:flex; justify-content:space-between; align-items:center; gap:6px; }
  .order-items{ display:flex; gap:8px; margin-top:8px }
  .order-items img{ width:72px; height:72px; object-fit:contain; border:1px solid #e3f5eb; border-radius:10px; background:#f2fff7 }
  .admin{ display:none; margin-top:8px; padding:10px; border-radius:12px; background:#f6fffa; border:1px dashed #bfead6 }
  .admin label{ font-size:12px; color:#225f4b }
  .admin .row{ display:flex; gap:8px; margin-top:6px; flex-wrap:wrap }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo" id="logo">
      <div class="mark">m</div>
      <div class="name">midzumi</div>
    </div>
  </header>
  <div class="hint">Соберите свою клавиатуру: выберите основу, свитчи и кейкапы. Для Telegram Mini App.</div>

  <!-- Меню категорий -->
  <nav class="menu" aria-label="Категории">
    <button data-block="keycaps-block" aria-controls="keycaps-block" aria-expanded="false">
      <div class="ic">⌨️</div>
      <div>
        <div class="ttl">Кейкапы</div>
        <div class="sub">6 вариантов • слайдер фото</div>
      </div>
    </button>
    <button data-block="switches-block" aria-controls="switches-block" aria-expanded="false">
      <div class="ic">🎧</div>
      <div>
        <div class="ttl">Свитчи</div>
        <div class="sub">6 вариантов • звук</div>
      </div>
    </button>
    <button data-block="bases-block" aria-controls="bases-block" aria-expanded="false">
      <div class="ic">🧱</div>
      <div>
        <div class="ttl">Основы</div>
        <div class="sub">6 вариантов • слайдер фото</div>
      </div>
    </button>
  </nav>

  <div class="divider"></div>

  <!-- Секции-сетки -->
  <section id="keycaps-block" class="block" aria-label="Кейкапы"></section>
  <section id="switches-block" class="block" aria-label="Свитчи"></section>
  <section id="bases-block"   class="block" aria-label="Основы"></section>

  <!-- Корзина -->
  <section class="panel">
    <h3>Ваша комплектация</h3>
    <div id="order-items">
      <div class="slot">
        <img id="order-keycap" alt="Кейкап" src="">
        <div class="name" id="name-keycap">Кейкап не выбран</div>
        <div class="price" id="price-keycap"></div>
      </div>
      <div class="slot">
        <img id="order-switch" alt="Свитч" src="">
        <div class="name" id="name-switch">Свитч не выбран</div>
        <div class="price" id="price-switch"></div>
      </div>
      <div class="slot">
        <img id="order-base" alt="Основа" src="">
        <div class="name" id="name-base">Основа не выбрана</div>
        <div class="price" id="price-base"></div>
      </div>
    </div>
    <div class="summary-row muted"><span>Сумма комплектующих:</span><span id="subtotal">0 ₽</span></div>
    <div class="summary-row muted"><span>Скидка по промокоду:</span><span id="discount">0 ₽</span></div>
    <div class="summary-row muted"><span>Доставка:</span><span id="shipping">0 ₽</span></div>
    <div class="summary-row"><span class="total">Итого к оплате:</span><span class="total" id="grand">0 ₽</span></div>
    <div class="summary-row">
      <button class="btn" id="place-order">Оформить заказ</button>
    </div>
  </section>

  <!-- Доставка / Промокод / Оплата -->
  <section class="panel">
    <h3>Доставка</h3>
    <div class="field">
      <label for="delivery">Способ доставки по РФ</label>
      <select id="delivery">
        <option value="300">СДЭК — 300 ₽</option>
        <option value="500">Курьер — 500 ₽</option>
        <option value="0">Самовывоз — бесплатно</option>
      </select>
    </div>

    <div class="field">
      <label for="promo">Промокод</label>
      <div class="promo-row">
        <input type="text" id="promo" placeholder="Введите промокод (напр. Egomix)" autocomplete="one-time-code" />
        <button class="promo-apply" id="apply-promo" type="button">Применить</button>
      </div>
      <div class="promo-feedback" id="promo-feedback">
        <span class="check" id="promo-check"></span>
        <span id="promo-msg" class="muted"></span>
      </div>
      <div class="muted">Скидка 20% применяется только к стоимости комплектующих (без доставки).</div>
    </div>

    <div class="field">
      <label>Оплата</label>
      <div class="radios" role="radiogroup" aria-label="Способ оплаты">
        <label><input type="radio" name="payment" value="crypto" checked> Криптовалюта</label>
        <label><input type="radio" name="payment" value="sbp"> СБП</label>
        <label><input type="radio" name="payment" value="card"> Банковская карта</label>
      </div>
    </div>
  </section>

  <!-- Мои заказы -->
  <section class="panel">
    <h3>Мои заказы</h3>
    <div id="orders"></div>
    <div class="muted">* Для изменения статуса включите админ-режим: добавьте к адресу страницы <span class="pill">?admin=1</span></div>
  </section>
</div>

<!-- Кнопка наверх -->
<button class="to-top" id="toTop" aria-label="Наверх">⬆️</button>

<!-- Модальное окно -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="m-title">
  <div class="modal-content">
    <div class="modal-head">
      <div class="modal-title" id="m-title">Просмотр</div>
      <button class="modal-close" id="modal-close" aria-label="Закрыть">✕</button>
    </div>
    <div class="modal-img-wrap">
      <img id="modal-img" class="modal-img" src="" alt="Фото товара">
      <div class="nav">
        <button id="nav-left" aria-label="Предыдущее">❮</button>
        <button id="nav-right" aria-label="Следующее">❯</button>
      </div>
    </div>
    <div class="modal-price" id="modal-price"></div>
    <div class="modal-desc"  id="modal-desc"></div>
    <div class="modal-extra" id="modal-extra"></div>
    <button class="btn-add" id="modal-add-btn">Добавить в сборку</button>
  </div>
</div>

<script>
/* ===================== ДАННЫЕ ===================== */
/* Вставьте свои изображения. Для примера используются заглушки. */
const data = {
  keycaps: [
    {id:1, images:["https://i.imgur.com/8cb4LyT.jpeg","https://i.imgur.com/2.png","https://i.imgur.com/3.png"], price:1200, desc:"Кейкап #1 — PBT, двойное литьё"},
    {id:2, images:["https://i.imgur.com/yswuUCY.jpeg","https://i.imgur.com/5.png","https://i.imgur.com/6.png"], price:1300, desc:"Кейкап #2 — профиль Cherry"},
    {id:3, images:["https://i.imgur.com/6QtIrU2.jpeg","https://i.imgur.com/8.png","https://i.imgur.com/9.png"], price:1400, desc:"Кейкап #3 — матовая поверхность"},
    {id:4, images:["https://i.imgur.com/HkuASV2.jpeg","https://i.imgur.com/11.png","https://i.imgur.com/12.png"], price:1250, desc:"Кейкап #4 — легенды MG"},
    {id:5, images:["https://i.imgur.com/nECsM2O.jpeg","https://i.imgur.com/14.png","https://i.imgur.com/15.png"], price:1350, desc:"Кейкап #5 — RGB shine-through"},
    {id:6, images:["https://i.imgur.com/HZVY2bv.jpeg","https://i.imgur.com/17.png","https://i.imgur.com/18.png"], price:1450, desc:"Кейкап #6 — лимитированная серия"}
  ],
  switches: [
    {id:1, img:"https://i.imgur.com/vqPDI2L.jpeg", price:500, sound:"https://actions.google.com/sounds/v1/door/door_knock_1.ogg", desc:"Свитч #1 — линейный 45g"},
    {id:2, img:"https://i.imgur.com/HL6zN2i.jpeg", price:600, sound:"https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg", desc:"Свитч #2 — тактильный 55g"},
    {id:3, img:"https://i.imgur.com/1KXQN7p.jpeg", price:550, sound:"https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg", desc:"Свитч #3 — клики 60g"},
    {id:4, img:"https://i.imgur.com/v3nyRUd.jpeg", price:530, sound:"https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg", desc:"Свитч #4 — линейный 50g"},
    {id:5, img:"https://i.imgur.com/8PjWYbt.jpeg", price:580, sound:"https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg", desc:"Свитч #5 — тактильный 62g"},
    {id:6, img:"https://i.imgur.com/7Erwkvk.jpeg", price:520, sound:"https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg", desc:"Свитч #6 — тихий линейный"}
  ],
  bases: [
    {id:1, images:["https://i.imgur.com/GVr4gGO.jpeg","https://i.imgur.com/b2.png","https://i.imgur.com/b3.png"], price:7000, material:"Алюминий", os:"Windows, Mac", connection:"Проводное", battery:"—", desc:"Основа #1 — TKL"},
    {id:2, images:["https://i.imgur.com/5ltJ91F.jpeg","https://i.imgur.com/b5.png","https://i.imgur.com/b6.png"], price:7500, material:"Пластик", os:"Windows", connection:"Беспроводное", battery:"3000mAh", desc:"Основа #2 — полноразмер"},
    {id:3, images:["https://i.imgur.com/2QfZGFR.jpeg","https://i.imgur.com/b8.png","https://i.imgur.com/b9.png"], price:7200, material:"Дерево", os:"Mac", connection:"Проводное", battery:"—", desc:"Основа #3 — 65%"},
    {id:4, images:["https://i.imgur.com/U5S63KY.jpeg","https://i.imgur.com/b11.png","https://i.imgur.com/b12.png"], price:8000, material:"Алюминий", os:"Windows, Mac", connection:"Беспроводное", battery:"4000mAh", desc:"Основа #4 — 75% hotswap"},
    {id:5, images:["https://i.imgur.com/DtfgLjz.jpeg","https://i.imgur.com/b14.png","https://i.imgur.com/b15.png"], price:6800, material:"Пластик", os:"Windows", connection:"Проводное", battery:"—", desc:"Основа #5 — бюджет"},
    {id:6, images:["https://i.imgur.com/5kMDXpc.jpeg","https://i.imgur.com/b17.png","https://i.imgur.com/b18.png"], price:6900, material:"Дерево", os:"Mac", connection:"Беспроводное", battery:"3500mAh", desc:"Основа #6 — винтаж"}
  ]
};

/* Список промокодов (встроенная «база») — 20% скидка на комплектующие */
const PROMO_DB = {
  "Egomix":   { uses: 0 },
  "SPRING20": { uses: 0 },
  "MZVIP20":  { uses: 0 }
};
/* Восстановление счётчиков промокодов из localStorage */
(function restorePromoUses(){
  const saved = JSON.parse(localStorage.getItem('promoUsage') || '{}');
  Object.keys(PROMO_DB).forEach(k => PROMO_DB[k].uses = saved[k] || 0);
})();

/* ===================== СОСТОЯНИЕ ===================== */
const blocks = {
  keycaps: document.getElementById('keycaps-block'),
  switches: document.getElementById('switches-block'),
  bases:   document.getElementById('bases-block')
};
let order = {
  keycap:null, switch:null, base:null,
  deliveryCost: 300,
  paymentMethod: 'crypto',
  promoCode: null
};

let currentCategory = '';
let currentItem = null;
let currentImages = [];
let currentIndex  = 0;

/* ===================== UI ССЫЛКИ ===================== */
const menuButtons = document.querySelectorAll('.menu button');

const orderImgs = {
  keycap: document.getElementById('order-keycap'),
  switch: document.getElementById('order-switch'),
  base:   document.getElementById('order-base')
};
const orderNames = {
  keycap: document.getElementById('name-keycap'),
  switch: document.getElementById('name-switch'),
  base:   document.getElementById('name-base')
};
const orderPrices = {
  keycap: document.getElementById('price-keycap'),
  switch: document.getElementById('price-switch'),
  base:   document.getElementById('price-base')
};
const subtotalEl = document.getElementById('subtotal');
const discountEl = document.getElementById('discount');
const shippingEl = document.getElementById('shipping');
const grandEl    = document.getElementById('grand');

const deliverySelect = document.getElementById('delivery');
const paymentRadios  = document.querySelectorAll('input[name="payment"]');
const placeOrderBtn  = document.getElementById('place-order');

const promoInput  = document.getElementById('promo');
const promoApply  = document.getElementById('apply-promo');
const promoMsg    = document.getElementById('promo-msg');
const promoCheck  = document.getElementById('promo-check');

const ordersWrap  = document.getElementById('orders');

const toTopBtn    = document.getElementById('toTop');

/* ===================== РЕНДЕР СЕТОК ===================== */
function renderGrid(category){
  const container = blocks[category];
  container.innerHTML = '';
  container.classList.add('grid');

  data[category].slice(0,6).forEach(item=>{
    const tile = document.createElement('div');
    tile.className='item';
    const imgSrc = item.images ? item.images[0] : item.img;
    tile.innerHTML = `
      <span class="price-tag">${item.price.toLocaleString('ru-RU')} ₽</span>
      <img src="${imgSrc}" alt="${item.desc}">
      <div class="caption">${item.desc}</div>
    `;
    tile.addEventListener('click', ()=>openModal(item,category));
    container.appendChild(tile);
  });
}

/* ===================== МОДАЛЬНОЕ ОКНО ===================== */
const modal      = document.getElementById('modal');
const modalImg   = document.getElementById('modal-img');
const modalPrice = document.getElementById('modal-price');
const modalDesc  = document.getElementById('modal-desc');
const modalExtra = document.getElementById('modal-extra');
const modalAdd   = document.getElementById('modal-add-btn');
const modalClose = document.getElementById('modal-close');
const navLeft    = document.getElementById('nav-left');
const navRight   = document.getElementById('nav-right');

function openModal(item, category){
  currentCategory = category;
  currentItem = item;
  currentImages = item.images ? item.images.slice(0,3) : (item.img ? [item.img] : []);
  currentIndex = 0;

  modalImg.src = currentImages[0] || '';
  modalPrice.textContent = `Цена: ${item.price.toLocaleString('ru-RU')} ₽`;
  modalDesc.textContent  = item.desc || '';
  modalExtra.innerHTML   = '';

  if(category === 'bases'){
    modalExtra.innerHTML = `
      <div><b>Материал:</b> ${item.material}</div>
      <div><b>ОС:</b> ${item.os}</div>
      <div><b>Подключение:</b> ${item.connection}</div>
      <div><b>Аккумулятор:</b> ${item.battery}</div>
    `;
  }
  if(category === 'switches' && item.sound){
    const btn = document.createElement('button');
    btn.className='sound-btn';
    btn.textContent='🔊 Проиграть звук';
    btn.onclick = ()=> new Audio(item.sound).play();
    modalExtra.appendChild(btn);
  }

  updateNavVisibility();
  modal.style.display='block';

  modalAdd.onclick = ()=>{
    if(currentCategory==='keycaps') order.keycap = currentItem;
    if(currentCategory==='switches') order.switch = currentItem;
    if(currentCategory==='bases')   order.base   = currentItem;
    persistDraft();
    updateOrderView();
    closeModal();
  }
}
function closeModal(){ modal.style.display='none'; }
modalClose.addEventListener('click', closeModal);
window.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
window.addEventListener('keydown', (e)=>{
  if(modal.style.display==='block'){
    if(e.key==='Escape') closeModal();
    if(e.key==='ArrowLeft')  navLeft.click();
    if(e.key==='ArrowRight') navRight.click();
  }
});
function updateNavVisibility(){
  const multi = currentImages.length>1;
  navLeft.style.visibility = multi?'visible':'hidden';
  navRight.style.visibility = multi?'visible':'hidden';
}
navLeft.addEventListener('click', ()=>{
  if(currentImages.length>1){
    currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
    modalImg.src = currentImages[currentIndex];
  }
});
navRight.addEventListener('click', ()=>{
  if(currentImages.length>1){
    currentIndex = (currentIndex + 1) % currentImages.length;
    modalImg.src = currentImages[currentIndex];
  }
});

/* ===================== МЕНЮ КАТЕГОРИЙ ===================== */
menuButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id = btn.dataset.block; // e.g. keycaps-block
    const cat = id.split('-')[0];

    Object.values(blocks).forEach(b=>b.classList.remove('active'));
    const section = document.getElementById(id);
    if(section && section.children.length===0){ renderGrid(cat); }
    section?.classList.add('active');

    // ARIA
    menuButtons.forEach(b=>b.setAttribute('aria-expanded','false'));
    btn.setAttribute('aria-expanded','true');

    section?.scrollIntoView({behavior:'smooth', block:'start'});
  });
});

/* ===================== ПРОМОКОД ===================== */
function savePromoUsage(){
  const out = {};
  Object.keys(PROMO_DB).forEach(k => out[k] = PROMO_DB[k].uses);
  localStorage.setItem('promoUsage', JSON.stringify(out));
}
function applyPromo(code){
  const c = (code||'').trim();
  promoCheck.style.display = 'none';
  promoMsg.textContent = '';
  promoMsg.className = '';

  if(!c){ promoMsg.textContent='Введите код'; promoMsg.classList.add('error'); return; }

  if(PROMO_DB[c]){
    order.promoCode = c;
    PROMO_DB[c].uses += 1;
    savePromoUsage();

    promoCheck.style.display = 'inline-block'; // зелёная галочка с анимацией
    promoMsg.textContent = `Промокод применён: ${c}`;
    promoMsg.classList.add('ok');
    persistDraft();
    updateOrderView();
  }else{
    order.promoCode = null;
    promoMsg.textContent = 'Такого промокода не существует';
    promoMsg.classList.add('error');
    persistDraft();
    updateOrderView();
  }
}
promoApply.addEventListener('click', ()=> applyPromo(promoInput.value));
promoInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ applyPromo(promoInput.value) }});

/* ===================== ИТОГИ ===================== */
function calcSubtotal(){
  return (order.keycap?.price||0) + (order.switch?.price||0) + (order.base?.price||0);
}
function calcDiscount(subtotal){
  // Любой валидный промо — 20% на комплектующие, но не на доставку
  return order.promoCode && PROMO_DB[order.promoCode] ? Math.round(subtotal * 0.20) : 0;
}
function updateOrderView(){
  // Картинки
  orderImgs.keycap.src = order.keycap ? (order.keycap.images ? order.keycap.images[0] : order.keycap.img) : '';
  orderImgs.switch.src = order.switch ? order.switch.img : '';
  orderImgs.base.src   = order.base   ? (order.base.images ? order.base.images[0]   : order.base.img) : '';

  // Названия
  orderNames.keycap.textContent = order.keycap ? order.keycap.desc : 'Кейкап не выбран';
  orderNames.switch.textContent = order.switch ? order.switch.desc : 'Свитч не выбран';
  orderNames.base.textContent   = order.base   ? order.base.desc   : 'Основа не выбрана';

  // Цены под слотами
  orderPrices.keycap.textContent = order.keycap ? `${order.keycap.price.toLocaleString('ru-RU')} ₽` : '';
  orderPrices.switch.textContent = order.switch ? `${order.switch.price.toLocaleString('ru-RU')} ₽` : '';
  orderPrices.base.textContent   = order.base   ? `${order.base.price.toLocaleString('ru-RU')} ₽`   : '';

  // Подсчёты
  const subtotal = calcSubtotal();
  const discount = calcDiscount(subtotal);
  const shipping = Number(order.deliveryCost||0);
  const grand = Math.max(0, subtotal - discount) + shipping;

  subtotalEl.textContent = `${subtotal.toLocaleString('ru-RU')} ₽`;
  discountEl.textContent = `−${discount.toLocaleString('ru-RU')} ₽`;
  shippingEl.textContent = `${shipping.toLocaleString('ru-RU')} ₽`;
  grandEl.textContent    = `${grand.toLocaleString('ru-RU')} ₽`;
}

/* ===================== ДОСТАВКА И ОПЛАТА ===================== */
deliverySelect.addEventListener('change', (e)=>{
  order.deliveryCost = Number(e.target.value||0);
  persistDraft(); updateOrderView();
});
paymentRadios.forEach(r=> r.addEventListener('change', (e)=>{
  if(e.target.checked){ order.paymentMethod = e.target.value; persistDraft(); }
}));

/* ===================== ЗАКАЗЫ (localStorage) ===================== */
const DB_KEY_ORDERS = 'midzumi_orders';
function loadOrders(){
  try { return JSON.parse(localStorage.getItem(DB_KEY_ORDERS)||'[]'); }
  catch(e){ return []; }
}
function saveOrders(list){
  localStorage.setItem(DB_KEY_ORDERS, JSON.stringify(list));
}
/* Черновик текущей сборки */
function persistDraft(){
  localStorage.setItem('midzumi_draft', JSON.stringify(order));
}
function restoreDraft(){
  try{
    const d = JSON.parse(localStorage.getItem('midzumi_draft')||'null');
    if(!d) return;
    order = Object.assign(order, d);
    // восстановить UI промо
    if(order.promoCode && PROMO_DB[order.promoCode]){
      promoInput.value = order.promoCode;
      promoCheck.style.display = 'inline-block';
      promoMsg.textContent = `Промокод применён: ${order.promoCode}`;
      promoMsg.classList.add('ok');
    }
    deliverySelect.value = String(order.deliveryCost);
    paymentRadios.forEach(r=> r.checked = (r.value===order.paymentMethod));
  }catch(e){}
}

/* Оформить заказ */
placeOrderBtn.addEventListener('click', ()=>{
  if(!order.keycap || !order.switch || !order.base){
    alert('Пожалуйста, выберите основу, свитчи и кейкапы перед оформлением.');
    return;
  }
  const subtotal = calcSubtotal();
  const discount = calcDiscount(subtotal);
  const shipping = Number(order.deliveryCost||0);
  const grand = Math.max(0, subtotal - discount) + shipping;

  const newOrder = {
    id: 'MZ-' + Date.now(),
    createdAt: new Date().toISOString(),
    items: {
      keycap: order.keycap, switch: order.switch, base: order.base
    },
    pricing: { subtotal, discount, shipping, total: grand, promo: order.promoCode || null },
    payment: order.paymentMethod,
    status: 'Ожидает сборки',           // начальный статус
    shipDate: null                      // админ может проставить
  };

  const list = loadOrders();
  list.unshift(newOrder);
  saveOrders(list);

  // Очистить текущую сборку
  order.keycap = order.switch = order.base = null;
  // Не сбрасываем доставку/оплату/промо по UX, но можно:
  // order.promoCode = null;
  persistDraft();
  updateOrderView();
  renderOrders();

  alert('Заказ оформлен! Он появился в разделе «Мои заказы».');
});

/* Рендер заказов + админ-режим */
const isAdmin = /[?&]admin=1\b/.test(location.search);
function renderOrders(){
  const list = loadOrders();
  ordersWrap.innerHTML = '';
  if(list.length===0){
    ordersWrap.innerHTML = '<div class="muted">Пока нет заказов.</div>';
    return;
  }
  list.forEach(o=>{
    const el = document.createElement('div');
    el.className='order';
    el.innerHTML = `
      <div class="order-head">
        <div><b>${o.id}</b> · <span class="muted">${new Date(o.createdAt).toLocaleString('ru-RU')}</span></div>
        <div class="pill">${o.status}${o.shipDate ? ' · отправка: ' + new Date(o.shipDate).toLocaleDateString('ru-RU') : ''}</div>
      </div>
      <div class="order-items">
        <img src="${o.items.keycap.images?o.items.keycap.images[0]:o.items.keycap.img}" alt="кейкап">
        <img src="${o.items.switch.img}" alt="свитч">
        <img src="${o.items.base.images?o.items.base.images[0]:o.items.base.img}" alt="основа">
      </div>
      <div class="summary-row" style="margin-top:6px">
        <span class="muted">Итого:</span>
        <span class="total">${o.pricing.total.toLocaleString('ru-RU')} ₽</span>
      </div>
      <div class="admin">
        <div class="row">
          <label>Статус:
            <select class="adm-status">
              <option ${o.status==='Ожидает сборки'?'selected':''}>Ожидает сборки</option>
              <option ${o.status==='Собирается'?'selected':''}>Собирается</option>
              <option ${o.status==='Отправлен'?'selected':''}>Отправлен</option>
              <option ${o.status==='Доставлен'?'selected':''}>Доставлен</option>
              <option ${o.status==='Отменён'?'selected':''}>Отменён</option>
            </select>
          </label>
          <label>Дата отправки:
            <input type="date" class="adm-date" value="${o.shipDate ? new Date(o.shipDate).toISOString().slice(0,10) : ''}">
          </label>
          <button class="promo-apply adm-save" type="button">Сохранить</button>
        </div>
      </div>
    `;
    const adminBox = el.querySelector('.admin');
    if(isAdmin){ adminBox.style.display='block'; }

    const saveBtn = el.querySelector('.adm-save');
    if(saveBtn){
      saveBtn.addEventListener('click', ()=>{
        const newStatus = el.querySelector('.adm-status').value;
        const newDate   = el.querySelector('.adm-date').value || null;
        // обновляем в «базе»
        const arr = loadOrders();
        const idx = arr.findIndex(x=>x.id===o.id);
        if(idx>-1){
          arr[idx].status = newStatus;
          arr[idx].shipDate = newDate ? new Date(newDate).toISOString() : null;
          saveOrders(arr);
          renderOrders();
          alert('Изменения сохранены.');
        }
      });
    }
    ordersWrap.appendChild(el);
  });
}

/* ===================== НАВЕРХ ===================== */
toTopBtn.addEventListener('click', ()=>{
  window.scrollTo({top:0, behavior:'smooth'});
});

/* ===================== ИНИЦИАЛИЗАЦИЯ ===================== */
/* Telegram Mini App readiness (без зависимости). Не обязателен, но безопасен. */
(function initTelegram(){
  try{
    if(window.Telegram && Telegram.WebApp){
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      // Можно передавать данные заказа через Telegram.WebApp.sendData(...)
    }
  }catch(e){}
})();

restoreDraft();
updateOrderView();
renderOrders();

/* По UX сначала показываем «Основы» */
(function openDefault(){
  const btn = document.querySelector('button[data-block="bases-block"]');
  btn?.click();
})();

</script>
</body>
</html>
