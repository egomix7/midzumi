<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#e8f8ee">
<title>midzumi — Конфигуратор клавиатуры</title>
<style>
  :root{
    --bg:#f3fbf6; --card:#ffffff; --text:#173a2b; --muted:#6b7a82; --line:#cfe9da;
    --accent:#28b487; --accent-2:#1ea97a; --ring:#a7e8c7; --success:#0f9d58; --danger:#e63946;
    --shadow:0 10px 30px rgba(22,120,86,0.12);
    --bottom-bar-height:78px;
    --topbar-height:64px;
    --maxw:480px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;color:var(--text);background:
    radial-gradient(900px 420px at 10% -10%, #d6f6e3 0%, transparent 60%), var(--bg);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  /* Centered app */
  .app{max-width:var(--maxw);margin:0 auto; padding: calc(var(--topbar-height) + 14px) 12px calc(env(safe-area-inset-bottom) + var(--bottom-bar-height) + 20px);}
  @media (min-width:500px){ .app{padding-left:16px;padding-right:16px} }

  /* Fixed dynamic topbar (only logo + name) */
  .topbar{position:fixed;top:0;left:0;right:0;height:var(--topbar-height);
    display:flex;align-items:center;justify-content:center;
    padding:8px 12px;background:linear-gradient(180deg,#f3fbf6 70%,#f3fbf600);
    z-index:1200;backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid #e9f7ef80;}
  .logo{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:14px;
    background:linear-gradient(180deg,#eafaf1,#dff6eb);border:1px solid var(--line);
    box-shadow:var(--shadow); transform-origin:50% 0%; transition:transform .2s ease}
  .logo.shrink{transform:scale(.92)}
  .mark{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;
    color:#fff;font-weight:900;background:linear-gradient(180deg,#2fd39c,#1ea97a);font-size:18px}
  .name{font-weight:900;color:#1e7156}

  /* Section headings */
  .h1{font-size:22px;font-weight:900;color:#0f5132;text-align:center;margin:6px 0 14px}

  /* Horizontal category buttons (no emoji) */
  .cats{display:flex;gap:8px; margin:6px 0 10px}
  .cat-btn{flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
    background:linear-gradient(180deg,#f6fffa,#e9fbf1); color:#145c48; font-weight:900; cursor:pointer;
    box-shadow:var(--shadow); transition:transform .05s ease}
  .cat-btn:active{transform:translateY(1px)}
  .cat-btn.active{box-shadow:0 0 0 4px var(--ring), var(--shadow);}

  /* Grid 3x3 */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:360px){.grid{grid-template-columns:repeat(2,1fr)}}
  .item{background:var(--card);border-radius:12px;border:1px solid var(--line);
    overflow:hidden;cursor:pointer;box-shadow:var(--shadow);display:flex;flex-direction:column}
  .item .img-wrap{position:relative}
  .item img{width:100%;height:100%;aspect-ratio:1/1;object-fit:cover;background:#f2fff7}
  .price-tag{position:absolute;top:8px;right:8px;background:linear-gradient(180deg,#2fd39c,#1ea97a);
    color:#fff;font-weight:800;font-size:11px;padding:4px 8px;border-radius:999px;box-shadow:0 6px 14px rgba(30,169,122,.18)}
  .caption{padding:8px;font-size:12px;color:#23543e;min-height:38px}

  /* Panels */
  .panel{background:var(--card);border-radius:14px;border:1px solid var(--line);
    padding:12px;box-shadow:var(--shadow);margin:24px 0 10px}
  .panel h3{margin:0 0 10px;color:#0f5132}

  /* Basket slots — make images dominate, show total inside */
  .slots{display:flex;gap:10px}
  .slot{flex:1 1 0;text-align:center;background:#f7fffb;border-radius:12px;border:1px dashed #cbe7d7;padding:8px}
  .slot img{width:100%;height:102px;object-fit:contain;border-radius:8px;background:#f2fff7;border:1px solid #e3f5eb}
  .slot .name{font-size:12px;margin-top:6px;color:#18593f;min-height:32px}
  .slot .price{font-weight:800;color:#1d7a5a;margin-top:3px}
  .basket-total{margin-top:8px;display:flex;justify-content:flex-end;gap:8px;align-items:center}
  .basket-total .label{color:#3a6a58}
  .basket-total .value{font-weight:900;color:#0f5132}

  /* Delivery select (fits overall design) */
  .field{display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .field label{font-size:13px;color:#2b5a47}
  select,input[type="text"]{padding:12px;border-radius:12px;border:1px solid var(--line);background:#f9fffb;font-size:14px}

  /* Promo bigger, placed after delivery and before totals */
  .promo-row{display:flex;gap:8px}
  .promo-apply{padding:12px 14px;border-radius:12px;border:1px solid #bfead6;background:#eafaf1;font-weight:900;cursor:pointer}
  .promo-feedback{margin-top:8px;display:flex;gap:8px;align-items:center;min-height:22px}
  /* FIXED: perfectly centered tick */
  .check{
    width:22px;height:22px;border-radius:50%;
    border:2px solid var(--success);
    display:none; /* will switch to grid by JS */
    position:relative;
    background:#f7fff9;
  }
  .check::after{
    content:"";
    position:absolute;
    left:50%; top:50%;
    width:7px; height:12px;
    border-right:3px solid var(--success);
    border-bottom:3px solid var(--success);
    transform:translate(-50%,-60%) rotate(45deg);
  }
  .ok{color:var(--success)} .error{color:var(--danger)}

  /* FIXED: brighter discount note while keeping style */
  .discount-title{
    font-size:13px;
    color:#145c48;
    opacity:.95;
    display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  }
  .discount-title .strong{
    font-weight:900;
    color:#0d6e50;
    background:linear-gradient(180deg,#bff3d9,#9fecc8);
    padding:2px 8px;border-radius:999px;
    box-shadow:0 0 0 1px #8fe7c280 inset;
  }

  /* Summary rows + place order */
  .summary-row{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:var(--muted)}
  .total{font-weight:900;color:#0f5132;font-size:16px}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px;width:100%;border-radius:12px;border:none;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;font-weight:900;cursor:pointer}
  .btn:active{transform:translateY(1px)}

  /* Product modal */
  .modal{display:none;position:fixed;inset:0;z-index:1400;background:rgba(0,0,0,0.45);padding:18px;display:flex;align-items:center;justify-content:center}
  .modal-content{width:min(94vw,520px);background:var(--card);border-radius:14px;padding:12px;border:1px solid var(--line);box-shadow:var(--shadow)}
  .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .modal-img-wrap{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#f2fff7}
  .modal-img{width:100%;display:block;max-height:54vh;object-fit:contain}
  .nav{position:absolute;inset:0;display:flex;align-items:center;justify-content:space-between;pointer-events:none}
  .nav button{pointer-events:auto;width:44px;height:44px;border-radius:999px;border:1px solid var(--line);background:#ffffffcc;cursor:pointer;font-size:18px}
  .dots{position:absolute;left:0;right:0;bottom:8px;display:flex;gap:6px;justify-content:center}
  .dot{width:8px;height:8px;border-radius:50%;background:#b8dfcc;border:1px solid #8fd7b8}
  .dot.active{background:#1ea97a}
  .sound-btn{margin-top:8px; display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:linear-gradient(180deg,#f6fffa,#e9fbf1); font-weight:900; color:#145c48; cursor:pointer}
  .sound-btn:active{transform:translateY(1px)}
  .modal-actions{margin-top:12px}

  /* Payment modal */
  .pay-modal{display:none;position:fixed;inset:0;z-index:1500;background:rgba(0,0,0,0.45);padding:18px;display:flex;align-items:center;justify-content:center}
  .pay-card{width:min(94vw,520px);background:var(--card);border-radius:14px;padding:12px;border:1px solid var(--line);box-shadow:var(--shadow)}
  .pay-methods{display:flex;flex-direction:column;gap:8px;margin:8px 0}
  .pay-methods label{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;border:1px solid var(--line);background:#f7fffb;cursor:pointer}
  .pay-details{margin-top:8px;padding:8px;border-radius:10px;border:1px dashed #cfe9da;background:#fbfff9;font-size:13px;color:#145c48}
  .mini-slot{flex:1;text-align:center;background:#f7fffb;border-radius:12px;border:1px dashed #cbe7d7;padding:8px}
  .mini-slot img{width:100%;height:72px;object-fit:contain;background:#f2fff7;border:1px solid #e3f5eb;border-radius:8px}

  /* Bottom nav — fixed and always visible */
  .bottom-bar{position:fixed;left:0;right:0;bottom:0;height:var(--bottom-bar-height);z-index:1300;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#ffffffee,#f7fffb);border-top:1px solid var(--line);box-shadow:0 -10px 30px rgba(22,120,86,0.06)}
  .bottom-tabs{width:100%;max-width:var(--maxw);display:flex;gap:10px;padding:10px;box-sizing:border-box}
  .bottom-btn{flex:1;display:flex;gap:8px;align-items:center;justify-content:center;padding:10px;border-radius:12px;border:1px solid var(--line);background:linear-gradient(180deg,#f6fffa,#e9fbf1);color:#145c48;font-weight:900;cursor:pointer}
  .bottom-btn.active{box-shadow:0 0 0 4px var(--ring),var(--shadow)}

  /* Orders page block */
  .orders-list{display:flex;flex-direction:column;gap:10px}
  .order{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px}
  .order-head{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .order-items{display:flex;gap:8px;margin-top:8px}
  .order-items img{width:72px;height:72px;object-fit:contain;border-radius:8px;border:1px solid #e3f5eb;background:#f2fff7}

  /* Community (removed display:none bug) */
  .comm-tabs{display:flex;gap:8px;margin:6px 0 12px}
  .comm-btn{flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
    background:linear-gradient(180deg,#f6fffa,#e9fbf1); color:#145c48; font-weight:900; cursor:pointer; box-shadow:var(--shadow)}
  .comm-btn.active{box-shadow:0 0 0 4px var(--ring), var(--shadow);}
  /* Posts like Instagram */
  .posts{display:flex;flex-direction:column;gap:10px}
  .post{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
  .post-head{display:flex;justify-content:space-between;align-items:center;padding:10px}
  .post-img{width:100%;height:260px;object-fit:cover;background:#f2fff7;border-top:1px solid #eaf4ee;border-bottom:1px solid #eaf4ee}
  .post-actions{display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
  .like-btn{padding:8px 12px;border-radius:12px;border:1px solid #ffd1db;background:#fff0f3;font-weight:800;color:#7a1a2f;cursor:pointer}
  .like-btn.liked{background:linear-gradient(180deg,#ffcdd5,#ffb7c3); border-color:#ff8fa3; color:#7a0f26}
  .more{background:none;border:none;color:#4b7d6a;font-weight:700;cursor:pointer}
  .comp-pop{padding:10px}
  .comp-grid{display:flex;gap:10px}
  .comp-grid .mini-slot img{height:84px}

  /* Reviews */
  .reviews-list{display:flex;flex-direction:column;gap:10px}
  .review{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;box-shadow:var(--shadow)}
  .review-head{display:flex;align-items:center;gap:10px}
  .review-img{width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid #e3f5eb;background:#f2fff7;cursor:pointer}
  .stars{color:#eab308;font-weight:900}
  .muted{color:var(--muted)}

  /* Helpers */
  .hidden{display:none !important}
  .divider{height:1px;background:var(--line);margin:12px 0}

  /* iPhone 12 safe space fit */
  @supports (padding:max(0px)) {
    .topbar{padding-top: max(8px, env(safe-area-inset-top));}
    .bottom-bar{padding-bottom: max(8px, env(safe-area-inset-bottom));}
  }
</style>
</head>
<body>
  <!-- Fixed Top Bar -->
  <div class="topbar">
    <div class="logo" id="top-logo"><div class="mark">湖</div><div class="name">midzumi</div></div>
  </div>

  <main class="app" id="app">
    <!-- CONFIGURATOR (this whole block hides on Orders/Community) -->
    <section id="configurator">
      <div class="h1">Конфигуратор клавиатуры</div>

      <!-- Horizontal categories -->
      <div class="cats" role="tablist" aria-label="Категории">
        <button class="cat-btn active" data-cat="bases" aria-pressed="true">Основы</button>
        <button class="cat-btn" data-cat="switches" aria-pressed="false">Свитчи</button>
        <button class="cat-btn" data-cat="keycaps" aria-pressed="false">Кейкапы</button>
      </div>

      <!-- Grid -->
      <section id="grid" class="grid" aria-live="polite" aria-label="Сетка товаров"></section>

      <!-- Basket -->
      <section class="panel" aria-label="Ваша комплектация" id="basket">
        <h3>Ваша комплектация</h3>
        <div class="slots" id="order-items">
          <div class="slot">
            <img id="order-keycap" src="" alt="Кейкап"/>
            <div class="name" id="name-keycap">Кейкап не выбран</div>
            <div class="price" id="price-keycap"></div>
          </div>
          <div class="slot">
            <img id="order-switch" src="" alt="Свитч"/>
            <div class="name" id="name-switch">Свитч не выбран</div>
            <div class="price" id="price-switch"></div>
          </div>
          <div class="slot">
            <img id="order-base" src="" alt="Основа"/>
            <div class="name" id="name-base">Основа не выбрана</div>
            <div class="price" id="price-base"></div>
          </div>
        </div>
        <div class="basket-total"><span class="label">Сумма клавиатуры:</span><span class="value" id="basket-total">0 ₽</span></div>
      </section>

      <!-- Delivery & promo & totals -->
      <section class="panel" id="delivery-panel" aria-label="Доставка и оплата">
        <h3>Доставка и оплата</h3>

        <!-- Delivery (styled select) -->
        <div class="field">
          <label for="delivery">Способ доставки</label>
          <select id="delivery" aria-label="Способ доставки">
            <option value="300">СДЭК — 300 ₽</option>
            <option value="500">Курьер — 500 ₽</option>
            <option value="0">Самовывоз — бесплатно</option>
          </select>
        </div>

        <!-- Promo (bigger, placed between delivery and totals) -->
        <div class="field">
          <label for="promo">Промокод</label>
          <div class="promo-row">
            <input id="promo" type="text" placeholder="Введите промокод (например, Egomix)" autocomplete="one-time-code">
            <button id="apply-promo" class="promo-apply" aria-label="Применить промокод">Применить</button>
          </div>
          <div class="promo-feedback" id="promo-feedback">
            <span id="promo-check" class="check" aria-hidden="true"></span>
            <span id="promo-msg" class="muted"></span>
          </div>
          <div id="discount-info" style="display:none">
            <div class="discount-title"><span class="strong">СКИДКА 20%</span> — действует только на стоимость комплектующих.</div>
          </div>
        </div>

        <!-- Totals -->
        <div style="margin-top:10px">
          <div class="summary-row"><span>Сумма комплектующих:</span><span id="subtotal">0 ₽</span></div>
          <div class="summary-row" id="row-discount" style="display:none"><span>Скидка по промокоду:</span><span id="discount">0 ₽</span></div>
          <div class="summary-row"><span>Доставка:</span><span id="shipping">0 ₽</span></div>
          <div class="summary-row"><span class="total">Итого к оплате:</span><span class="total" id="grand">0 ₽</span></div>
        </div>

        <div style="margin-top:12px"><button id="place-order" class="btn" aria-label="Оформить заказ">Оформить заказ</button></div>
      </section>

      <div class="divider"></div>
      <div class="muted" style="font-size:12px;text-align:center">Поддержка: для обращения пишите <b>@midzum7</b> в Telegram.</div>
    </section>

    <!-- ORDERS (only this remains visible when Orders tab is active) -->
    <section id="orders" class="hidden">
      <div class="h1">Мои заказы</div>
      <div class="orders-list" id="orders-list"></div>
    </section>

    <!-- COMMUNITY (only this remains visible when Community tab is active) -->
    <section id="community" class="hidden">
      <div class="h1">Сообщество</div>
      <div class="comm-tabs" role="tablist" aria-label="Сообщество">
        <button class="comm-btn active" data-tab="keyboards">Клавиатуры</button>
        <button class="comm-btn" data-tab="reviews">Отзывы</button>
      </div>
      <div id="community-content"></div>
    </section>
  </main>

  <!-- Product modal -->
  <div id="product-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content" role="document">
      <div class="modal-head">
        <div style="font-weight:800;color:#145c48">Просмотр товара</div>
        <button id="modal-close" aria-label="Закрыть" style="padding:6px 8px;border-radius:10px;border:1px solid var(--line);background:#f2fff7;cursor:pointer">✕</button>
      </div>
      <div class="modal-img-wrap">
        <img id="modal-img" class="modal-img" src="" alt="Фото товара">
        <div class="nav" id="modal-nav">
          <button id="nav-left" aria-label="Предыдущее фото">❮</button>
          <button id="nav-right" aria-label="Следующее фото">❯</button>
        </div>
        <div class="dots" id="dots"></div>
      </div>
      <div style="margin-top:10px">
        <div id="modal-price" style="font-weight:900;color:#0f5132"></div>
        <div id="modal-desc" style="color:#335c4d;margin-top:6px"></div>
        <div id="modal-extra" style="margin-top:8px;color:#1b6d53"></div>
      </div>
      <div class="modal-actions"><button id="modal-add-btn" class="btn">Добавить в сборку</button></div>
    </div>
  </div>

  <!-- Payment modal -->
  <div id="pay-modal" class="pay-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="pay-card" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:900;color:#145c48">Оформление заказа</div>
        <button id="pay-close" style="padding:6px 8px;border-radius:10px;border:1px solid var(--line);background:#f2fff7;cursor:pointer">✕</button>
      </div>

      <!-- Summary — mirrors basket with totals -->
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <div class="mini-slot"><img id="pay-img-keycap" alt=""><div style="font-size:12px;color:#145c48;margin-top:4px" id="pay-name-keycap"></div></div>
        <div class="mini-slot"><img id="pay-img-switch" alt=""><div style="font-size:12px;color:#145c48;margin-top:4px" id="pay-name-switch"></div></div>
        <div class="mini-slot"><img id="pay-img-base" alt=""><div style="font-size:12px;color:#145c48;margin-top:4px" id="pay-name-base"></div></div>
      </div>

      <div style="border-top:1px solid var(--line); padding-top:8px">
        <div class="summary-row"><span>Сумма комплектующих:</span><span id="pay-subtotal">0 ₽</span></div>
        <div class="summary-row" id="pay-row-discount" style="display:none"><span>Скидка по промокоду:</span><span id="pay-discount">0 ₽</span></div>
        <div class="summary-row"><span>Сборка:</span><span id="pay-assembly">0 ₽</span></div>
        <div class="summary-row"><span>Доставка:</span><span id="pay-shipping">0 ₽</span></div>
        <div class="summary-row"><span class="total">Итого к оплате:</span><span class="total" id="pay-total">0 ₽</span></div>
      </div>

      <div style="font-weight:800;color:#145c48;margin-top:8px">Способ оплаты</div>
      <div class="pay-methods" id="pay-methods">
        <label><input type="radio" name="pay" value="crypto" checked> Криптовалюта</label>
        <label><input type="radio" name="pay" value="sbp"> СБП</label>
        <label><input type="radio" name="pay" value="card"> Банковская карта</label>
      </div>
      <div id="pay-details" class="pay-details" style="display:none"></div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="confirm-pay" class="btn" style="flex:1">Оплатить и оформить</button>
      </div>
    </div>
  </div>

  <!-- Bottom navigation -->
  <div class="bottom-bar" role="navigation" aria-label="Нижняя навигация">
    <div class="bottom-tabs">
      <button id="tab-config" class="bottom-btn active" aria-pressed="true">🛠️ Конфигуратор</button>
      <button id="tab-orders" class="bottom-btn" aria-pressed="false">📦 Мои заказы</button>
      <button id="tab-community" class="bottom-btn" aria-pressed="false">👤 Сообщество</button>
    </div>
  </div>

<script>
/* ======================= ДАННЫЕ ======================= */
const data = {
  keycaps:[
    {id:1, images:["https://i.imgur.com/8cb4LyT.jpeg","https://images.unsplash.com/photo-1604866830546-cb3b2e5b0b87?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1618365908648-e71bd5716a00?q=80&w=800&auto=format&fit=crop"], price:1200, desc:"Кейкап #1 — PBT"},
    {id:2, images:["https://i.imgur.com/yswuUCY.jpeg","https://images.unsplash.com/photo-1606041008023-472dfb5e530f?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1605792657660-596af9009e82?q=80&w=800&auto=format&fit=crop"], price:1300, desc:"Кейкап #2 — Cherry"},
    {id:3, images:["https://i.imgur.com/6QtIrU2.jpeg","https://images.unsplash.com/photo-1603791440384-56cd371ee9a7?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1545239351-1141bd82e8a6?q=80&w=800&auto=format&fit=crop"], price:1400, desc:"Кейкап #3 — матовый"},
    {id:4, images:["https://i.imgur.com/HkuASV2.jpeg","https://images.unsplash.com/photo-1587825140400-3ccd7b9e8c72?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1527443154391-507e9dc6c5cc?q=80&w=800&auto=format&fit=crop"], price:1250, desc:"Кейкап #4"},
    {id:5, images:["https://i.imgur.com/nECsM2O.jpeg","https://images.unsplash.com/photo-1600267175161-cfaa711b4a71?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1511467687858-23d96c32e4ae?q=80&w=800&auto=format&fit=crop"], price:1350, desc:"Кейкап #5"},
    {id:6, images:["https://i.imgur.com/HZVY2bv.jpeg","https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1517336714731-489689fd1ca8?q=80&w=800&auto=format&fit=crop"], price:1450, desc:"Кейкап #6"},
    {id:7, images:["https://i.imgur.com/8cb4LyT.jpeg","https://images.unsplash.com/photo-1498050108023-c5249f4df085?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1483770959832-4d43f07e6875?q=80&w=800&auto=format&fit=crop"], price:1500, desc:"Кейкап #7"},
    {id:8, images:["https://i.imgur.com/yswuUCY.jpeg","https://images.unsplash.com/photo-1505740106531-4243f3831c78?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1473093295043-cdd812d0e601?q=80&w=800&auto=format&fit=crop"], price:1100, desc:"Кейкап #8"},
    {id:9, images:["https://i.imgur.com/6QtIrU2.jpeg","https://images.unsplash.com/photo-1593508512255-86ab42a8e620?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1563986768494-4dee2763ff3f?q=80&w=800&auto=format&fit=crop"], price:1600, desc:"Кейкап #9"},
  ],
  switches:[
    {id:1, img:"https://i.imgur.com/vqPDI2L.jpeg", price:500, sound:"https://actions.google.com/sounds/v1/door/door_knock_1.ogg", desc:"Свитч #1"},
    {id:2, img:"https://i.imgur.com/HL6zN2i.jpeg", price:600, sound:"https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg", desc:"Свитч #2"},
    {id:3, img:"https://i.imgur.com/1KXQN7p.jpeg", price:550, sound:"https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg", desc:"Свитч #3"},
    {id:4, img:"https://i.imgur.com/v3nyRUd.jpeg", price:530, sound:"https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg", desc:"Свитч #4"},
    {id:5, img:"https://i.imgur.com/8PjWYbt.jpeg", price:580, sound:"https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg", desc:"Свитч #5"},
    {id:6, img:"https://i.imgur.com/7Erwkvk.jpeg", price:520, sound:"https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg", desc:"Свитч #6"},
    {id:7, img:"https://i.imgur.com/vqPDI2L.jpeg", price:540, sound:"https://actions.google.com/sounds/v1/door/door_knock_1.ogg", desc:"Свитч #7"},
    {id:8, img:"https://i.imgur.com/HL6zN2i.jpeg", price:610, sound:"https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg", desc:"Свитч #8"},
    {id:9, img:"https://i.imgur.com/1KXQN7p.jpeg", price:590, sound:"https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg", desc:"Свитч #9"},
  ],
  bases:[
    {id:1, images:["https://i.imgur.com/GVr4gGO.jpeg","https://images.unsplash.com/photo-1585079542156-2755d9c8affc?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1515879218367-8466d910aaa4?q=80&w=800&auto=format&fit=crop"], price:7000, material:"Алюминий", os:"Windows, Mac", connection:"Проводное", battery:"—", desc:"Основа #1 — TKL"},
    {id:2, images:["https://i.imgur.com/5ltJ91F.jpeg","https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=800&auto=format&fit=crop"], price:7500, material:"Пластик", os:"Windows", connection:"Беспроводное", battery:"3000mAh", desc:"Основа #2 — полноразмер"},
    {id:3, images:["https://i.imgur.com/2QfZGFR.jpeg","https://images.unsplash.com/photo-1555066931-4365d14bab8c?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1551033406-611cf9a28f67?q=80&w=800&auto=format&fit=crop"], price:7200, material:"Дерево", os:"Mac", connection:"Проводное", battery:"—", desc:"Основа #3 — 65%"},
    {id:4, images:["https://i.imgur.com/U5S63KY.jpeg","https://images.unsplash.com/photo-1512758017271-d7b84c2113f1?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1556157382-97eda2d62296?q=80&w=800&auto=format&fit=crop"], price:8000, material:"Алюминий", os:"Windows, Mac", connection:"Беспроводное", battery:"4000mAh", desc:"Основа #4 — 75%"},
    {id:5, images:["https://i.imgur.com/DtfgLjz.jpeg","https://images.unsplash.com/photo-1517433456452-f9633a875f6f?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1510915228340-29c85a43dcfe?q=80&w=800&auto=format&fit=crop"], price:6800, material:"Пластик", os:"Windows", connection:"Проводное", battery:"—", desc:"Основа #5 — бюджет"},
    {id:6, images:["https://i.imgur.com/5kMDXpc.jpeg","https://images.unsplash.com/photo-1517694712202-14dd9538aa97?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1523475496153-3d6cc450ca68?q=80&w=800&auto=format&fit=crop"], price:6900, material:"Дерево", os:"Mac", connection:"Беспроводное", battery:"3500mAh", desc:"Основа #6 — винтаж"},
    {id:7, images:["https://i.imgur.com/GVr4gGO.jpeg","https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1522075469751-3a6694fb2f61?q=80&w=800&auto=format&fit=crop"], price:7100, material:"Алюминий", os:"Windows", connection:"Проводное", battery:"—", desc:"Основа #7"},
    {id:8, images:["https://i.imgur.com/5ltJ91F.jpeg","https://images.unsplash.com/photo-1487014679447-9f8336841d58?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=800&auto=format&fit=crop"], price:7300, material:"Пластик", os:"Windows", connection:"Беспроводное", battery:"3000mAh", desc:"Основа #8"},
    {id:9, images:["https://i.imgur.com/2QfZGFR.jpeg","https://images.unsplash.com/photo-1498050108023-c5249f4df085?q=80&w=800&auto=format&fit=crop","https://images.unsplash.com/photo-1555617117-08c5fb3bfe9b?q=80&w=800&auto=format&fit=crop"], price:7050, material:"Дерево", os:"Mac", connection:"Проводное", battery:"—", desc:"Основа #9"},
  ]
};
const PROMO_DB = {"Egomix":{uses:0},"SPRING20":{uses:0},"MZVIP20":{uses:0}};

/* Community seed (10 keyboards, 25 reviews total) */
const communityData = {
  posts:[
    {title:"Сборка #1", img:"https://images.unsplash.com/photo-1517336714731-489689fd1ca8?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[0], switch:data.switches?.[0]||{img:"",price:0,desc:""}, base:data.bases[0]}},
    {title:"Сборка #2", img:"https://images.unsplash.com/photo-1515879218367-8466d910aaa4?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[1], switch:data.switches?.[1]||{img:"",price:0,desc:""}, base:data.bases[1]}},
    {title:"Сборка #3", img:"https://images.unsplash.com/photo-1555066931-4365d14bab8c?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[2], switch:data.switches?.[2]||{img:"",price:0,desc:""}, base:data.bases[2]}},
    {title:"Сборка #4", img:"https://images.unsplash.com/photo-1556157382-97eda2d62296?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[3], switch:data.switches?.[3]||{img:"",price:0,desc:""}, base:data.bases[3]}},
    {title:"Сборка #5", img:"https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[4], switch:data.switches?.[4]||{img:"",price:0,desc:""}, base:data.bases[4]}},
    {title:"Сборка #6", img:"https://images.unsplash.com/photo-1512758017271-d7b84c2113f1?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[5], switch:data.switches?.[5]||{img:"",price:0,desc:""}, base:data.bases[5]}},
    {title:"Сборка #7", img:"https://images.unsplash.com/photo-1498050108023-c5249f4df085?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[6], switch:data.switches?.[6]||{img:"",price:0,desc:""}, base:data.bases[6]}},
    {title:"Сборка #8", img:"https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[7], switch:data.switches?.[7]||{img:"",price:0,desc:""}, base:data.bases[7]}},
    {title:"Сборка #9", img:"https://images.unsplash.com/photo-1522075469751-3a6694fb2f61?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[8], switch:data.switches?.[8]||{img:"",price:0,desc:""}, base:data.bases[8]}},
    {title:"Сборка #10", img:"https://images.unsplash.com/photo-1523475496153-3d6cc450ca68?q=80&w=1200&auto=format&fit=crop", likes: rndLikes(), liked:false,
     items:{ keycap:data.keycaps[0], switch:data.switches?.[2]||{img:"",price:0,desc:""}, base:data.bases[4]}},
  ],
  reviews:[]
};

(function seedReviews(){
  const baseReviews = [
    {r:4.8,t:'Очень приятное звучание после смазки, печатать одно удовольствие.'},
    {r:4.9,t:'Доставка быстрая, собрал за вечер. Рекомендую!'},
    {r:4.7,t:'Кейкапы не просвечивают, шрифт аккуратный, профиль удобный.'},
    {r:4.6,t:'Немного не хватило высоты ножек, но качество топ.'},
    {r:5.0,t:'Идеально для работы и игр, топ за свои деньги.'},
  ];
  const extra = [
    {r:4.7, t:'Долго сравнивал платы, выбрал эту из-за хороших стабов. Звук глухой, без дребезга.'},
    {r:4.9, t:'Колпачки ровные, без облоя. Подсветка мягкая, не бьёт в глаза.'},
    {r:5.0, t:'Сборка прошла без сюрпризов. Все винты и резьбы в порядке.'},
    {r:4.6, t:'Свитчи упакованы отлично. Хотелось бы больше вариантов пружин по жёсткости.'},
    {r:4.8, t:'75% — лучший форм-фактор. Добавил поролон — стало тише.'},
    {r:4.5, t:'PBT текстура цепкая, печатать приятно. Цвет ближе к молочному — мне зашло.'},
    {r:4.9, t:'Магазин ответил в тот же день, отправили оперативно.'},
    {r:4.7, t:'Клик мягкий, без звона. Скорость набора выросла через неделю.'},
    {r:4.8, t:'Тихие линейки для офиса. Коллеги благодарят :)'},
    {r:4.6, t:'На Mac всё определилось сразу. Хотелось бы больше схем в документации.'},
    {r:4.9, t:'После мембранки будто пересел из автобуса в спорткар.'},
    {r:5.0, t:'Низкопрофильные капы — пальцы меньше устают.'},
    {r:4.7, t:'Прокладки между платой и корпусом улучшили звук. Простор для модов отличный.'},
    {r:4.8, t:'Текстура не скользит летом. Русская легенда аккуратная.'},
    {r:4.9, t:'СДЭК привёз на следующий день, трек отслеживался нормально.'},
    {r:4.6, t:'Дарил другу — остался в восторге. Кабель коротковат, но решаемо.'},
    {r:4.8, t:'Линейные свитчи ровные, после капли смазки — шёлк.'},
    {r:4.9, t:'Подсветка равномерная, белый действительно белый.'},
    {r:4.7, t:'Стабы из коробки ок, после бандажа — просто песня.'},
    {r:4.5, t:'С клипсами повозился, но итог отличный. Рекомендую.'}
  ];
  const all = baseReviews.concat(extra); // 25
  for(let i=0;i<all.length;i++){
    const p = communityData.posts[i%communityData.posts.length];
    communityData.reviews.push({img:p.img, rating:all[i].r, text:all[i].t});
  }
})();

function rndLikes(){ return Math.floor(120 + Math.random()*900); }

/* ======================= ГЛОБАЛЬНОЕ СОСТОЯНИЕ ======================= */
let currentCategory='bases';
let order = { keycap:null, switch:null, base:null, deliveryCost:300, paymentMethod:'crypto', promoCode:null };
const IS_ADMIN = /\badmin=1\b/.test(location.search);

/* ======================= DOM ======================= */
const gridBlock = document.getElementById('grid');
const catBtns = document.querySelectorAll('.cat-btn');

const orderImgs = { keycap:document.getElementById('order-keycap'), switch:document.getElementById('order-switch'), base:document.getElementById('order-base') };
const orderNames = { keycap:document.getElementById('name-keycap'), switch:document.getElementById('name-switch'), base:document.getElementById('name-base') };
const orderPrices = { keycap:document.getElementById('price-keycap'), switch:document.getElementById('price-switch'), base:document.getElementById('price-base') };
const basketTotalEl = document.getElementById('basket-total');

const subtotalEl = document.getElementById('subtotal'), discountEl=document.getElementById('discount'), rowDiscount=document.getElementById('row-discount');
const shippingEl=document.getElementById('shipping'), grandEl=document.getElementById('grand');
const deliverySelect=document.getElementById('delivery'), placeOrderBtn=document.getElementById('place-order');

const promoInput=document.getElementById('promo'), promoApply=document.getElementById('apply-promo'), promoMsg=document.getElementById('promo-msg'), promoCheck=document.getElementById('promo-check');
const discountInfo=document.getElementById('discount-info');

const modal=document.getElementById('product-modal'), modalImg=document.getElementById('modal-img'), modalPrice=document.getElementById('modal-price'), modalDesc=document.getElementById('modal-desc'), modalExtra=document.getElementById('modal-extra');
const modalAddBtn=document.getElementById('modal-add-btn'), modalClose=document.getElementById('modal-close'), navLeft=document.getElementById('nav-left'), navRight=document.getElementById('nav-right'), dots=document.getElementById('dots'), modalNav=document.getElementById('modal-nav');

const payModal=document.getElementById('pay-modal'), payClose=document.getElementById('pay-close'), payMethods=document.getElementById('pay-methods'), payDetails=document.getElementById('pay-details'), confirmPay=document.getElementById('confirm-pay');
const payImgK=document.getElementById('pay-img-keycap'), payImgS=document.getElementById('pay-img-switch'), payImgB=document.getElementById('pay-img-base');
const payNameK=document.getElementById('pay-name-keycap'), payNameS=document.getElementById('pay-name-switch'), payNameB=document.getElementById('pay-name-base');
const paySub=document.getElementById('pay-subtotal'), payDisc=document.getElementById('pay-discount'), payShip=document.getElementById('pay-shipping'), payTotal=document.getElementById('pay-total'), payRowDisc=document.getElementById('pay-row-discount'), payAssembly=document.getElementById('pay-assembly');

const tabConfig=document.getElementById('tab-config'), tabOrders=document.getElementById('tab-orders'), tabCommunity=document.getElementById('tab-community');
const secConfigurator=document.getElementById('configurator'), secOrders=document.getElementById('orders'), secCommunity=document.getElementById('community');

const ordersList=document.getElementById('orders-list');

const topLogo=document.getElementById('top-logo');

/* ======================= ПРОМО ======================= */
(function restorePromoUses(){ try{ const saved=JSON.parse(localStorage.getItem('promoUsage')||'{}'); Object.keys(PROMO_DB).forEach(k=>PROMO_DB[k].uses=saved[k]||0); }catch(e){} })();
function savePromoUsage(){ const obj={}; Object.keys(PROMO_DB).forEach(k=>obj[k]=PROMO_DB[k].uses); localStorage.setItem('promoUsage', JSON.stringify(obj)); }

/* ======================= РЕНДЕР СЕТКИ ======================= */
function renderGrid(cat){
  currentCategory = cat;
  gridBlock.innerHTML = '';
  const list = (data[cat] || []).slice(0,9);
  list.forEach(item=>{
    const tile = document.createElement('div');
    tile.className = 'item';
    const imgSrc = item.images ? item.images[0] : (item.img || '');
    tile.innerHTML = `<div class="img-wrap">
        <img src="${escapeHtml(imgSrc)}" alt="${escapeHtml(item.desc||'')}"/>
        <div class="price-tag">${item.price.toLocaleString('ru-RU')} ₽</div>
      </div>
      <div class="caption">${escapeHtml(item.desc||'')}</div>`;
    tile.addEventListener('click', ()=> openModal(item, cat));
    gridBlock.appendChild(tile);
  });
  catBtns.forEach(b=>{
    const is = b.dataset.cat === cat;
    b.classList.toggle('active', is);
    b.setAttribute('aria-pressed', is ? 'true' : 'false');
  });
}

/* ======================= МОДАЛ ТОВАРА ======================= */
let currentItem=null, currentImages=[], currentIndex=0;
function openModal(item, category){
  currentItem = item;
  currentImages = item.images ? item.images.slice(0,3) : (item.img ? [item.img] : []);
  currentIndex = 0;

  // For switches: no carousel (single image, hide nav & dots)
  const isSwitch = (category === 'switches');
  const imgs = isSwitch ? [ item.img ] : currentImages;

  modalImg.src = imgs[0] || '';
  modalPrice.textContent = `Цена: ${item.price.toLocaleString('ru-RU')} ₽`;
  modalDesc.textContent = item.desc || '';
  modalExtra.innerHTML = '';

  if(category === 'bases'){
    modalExtra.innerHTML = `<div><b>Материал:</b> ${item.material}</div><div><b>ОС:</b> ${item.os}</div><div><b>Подключение:</b> ${item.connection}</div><div><b>Аккумулятор:</b> ${item.battery}</div>`;
  }
  if(category === 'switches' && item.sound){
    const b = document.createElement('button'); b.className='sound-btn'; b.innerHTML='🔊 Прослушать звук';
    b.addEventListener('click', ()=> new Audio(item.sound).play());
    modalExtra.appendChild(b);
  }

  // carousel state
  dots.innerHTML = '';
  if(isSwitch){
    modalNav.style.display='none';
  } else {
    modalNav.style.display = (imgs.length>1) ? '' : 'none';
    imgs.forEach((_,i)=> {
      const d = document.createElement('div'); d.className='dot'+(i===0?' active':''); dots.appendChild(d);
    });
  }

  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');

  modalAddBtn.onclick = ()=>{
    if(currentCategory === 'keycaps') order.keycap = currentItem;
    if(currentCategory === 'switches') order.switch = currentItem;
    if(currentCategory === 'bases') order.base = currentItem;
    persistDraft(); updateOrderView(); closeModal();
  };

  // nav
  navLeft.onclick = ()=> {
    if(isSwitch || imgs.length<=1) return;
    currentIndex=(currentIndex-1+imgs.length)%imgs.length; modalImg.src = imgs[currentIndex]; syncDots();
  };
  navRight.onclick = ()=> {
    if(isSwitch || imgs.length<=1) return;
    currentIndex=(currentIndex+1)%imgs.length; modalImg.src = imgs[currentIndex]; syncDots();
  };
  function syncDots(){
    [...dots.children].forEach((d,i)=> d.classList.toggle('active', i===currentIndex));
  }
}
function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
modalClose.addEventListener('click', closeModal);
window.addEventListener('click', e=> { if(e.target === modal) closeModal(); });
window.addEventListener('keydown', e => { if(modal.style.display === 'flex'){ if(e.key==='Escape') closeModal(); if(e.key==='ArrowLeft') navLeft.click(); if(e.key==='ArrowRight') navRight.click(); } });

/* ======================= ПРОМОКОД ======================= */
function applyPromo(code){
  const c = (code||'').trim();
  promoCheck.style.display = 'none'; promoMsg.textContent=''; promoMsg.className='muted';
  discountInfo.style.display = 'none'; rowDiscount.style.display = 'none';
  if(!c){ promoMsg.textContent = 'Введите код'; promoMsg.classList.add('error'); return; }
  if(PROMO_DB[c]){
    order.promoCode = c; PROMO_DB[c].uses += 1; savePromoUsage();
    promoCheck.style.display = 'grid'; /* will show perfectly centered tick */
    promoMsg.textContent = `Промокод применён: ${c}`; promoMsg.classList.add('ok');
    discountInfo.style.display = 'block'; rowDiscount.style.display = 'flex';
    persistDraft(); updateOrderView();
  } else {
    order.promoCode = null; promoMsg.textContent = 'Такого промокода не существует'; promoMsg.classList.add('error'); persistDraft(); updateOrderView();
  }
}
promoApply.addEventListener('click', ()=> applyPromo(promoInput.value));
promoInput.addEventListener('keydown', e => { if(e.key === 'Enter') applyPromo(promoInput.value); });

/* ======================= БОКОВЫЕ ВСПОМОГАТЕЛЬНЫЕ ======================= */
function calcSubtotal(){ return (order.keycap?.price||0) + (order.switch?.price||0) + (order.base?.price||0); }
function calcDiscount(subtotal){ return order.promoCode && PROMO_DB[order.promoCode] ? Math.round(subtotal * 0.20) : 0; }

function updateOrderView(){
  orderImgs.keycap.src = order.keycap ? (order.keycap.images ? order.keycap.images[0] : order.keycap.img) : '';
  orderImgs.switch.src = order.switch ? order.switch.img : '';
  orderImgs.base.src = order.base ? (order.base.images ? order.base.images[0] : order.base.img) : '';

  orderNames.keycap.textContent = order.keycap ? order.keycap.desc : 'Кейкап не выбран';
  orderNames.switch.textContent = order.switch ? order.switch.desc : 'Свитч не выбран';
  orderNames.base.textContent = order.base ? order.base.desc : 'Основа не выбрана';

  orderPrices.keycap.textContent = order.keycap ? `${order.keycap.price.toLocaleString('ru-RU')} ₽` : '';
  orderPrices.switch.textContent = order.switch ? `${order.switch.price.toLocaleString('ru-RU')} ₽` : '';
  orderPrices.base.textContent = order.base ? `${order.base.price.toLocaleString('ru-RU')} ₽` : '';

  const subtotal = calcSubtotal();
  const discount = calcDiscount(subtotal);
  const shipping = Number(order.deliveryCost||0);
  const grand = Math.max(0, subtotal - discount) + shipping;

  subtotalEl.textContent = `${subtotal.toLocaleString('ru-RU')} ₽`;
  discountEl.textContent = `−${discount.toLocaleString('ru-RU')} ₽`;
  shippingEl.textContent = `${shipping.toLocaleString('ru-RU')} ₽`;
  grandEl.textContent = `${grand.toLocaleString('ru-RU')} ₽`;
  basketTotalEl.textContent = `${(Math.max(0, subtotal - discount)).toLocaleString('ru-RU')} ₽`;

  // discount UI
  if(order.promoCode && PROMO_DB[order.promoCode]){
    promoCheck.style.display='grid';
    promoMsg.textContent = `Промокод применён: ${order.promoCode}`;
    promoMsg.classList.add('ok');
    discountInfo.style.display='block';
    rowDiscount.style.display='flex';
  } else {
    promoCheck.style.display='none';
    discountInfo.style.display='none';
    rowDiscount.style.display='none';
  }
}

/* ======================= PERSISTENCE ======================= */
const ORDERS_KEY = 'midzumi_orders';
function loadOrders(){ try{ return JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]'); }catch(e){ return []; } }
function saveOrders(list){ localStorage.setItem(ORDERS_KEY, JSON.stringify(list)); }

function persistDraft(){ localStorage.setItem('midzumi_draft', JSON.stringify(order)); }
(function restoreDraft(){
  try{
    const d = JSON.parse(localStorage.getItem('midzumi_draft')||'null'); if(!d) return;
    order = Object.assign(order, d);
    if(order.promoCode && PROMO_DB[order.promoCode]){ promoCheck.style.display='grid'; promoMsg.textContent = `Промокод применён: ${order.promoCode}`; promoMsg.classList.add('ok'); discountInfo.style.display='block'; rowDiscount.style.display='flex'; }
    if(order.deliveryCost!=null) deliverySelect.value = String(order.deliveryCost);
  }catch(e){}
})();

/* ======================= ОПЛАТА ======================= */
function openPay(){
  if(!order.keycap || !order.switch || !order.base){ alert('Выберите основу, свитчи и кейкапы перед оформлением.'); return; }
  const subtotal = calcSubtotal();
  const discount = calcDiscount(subtotal);
  const shipping = Number(order.deliveryCost||0);
  const total = Math.max(0, subtotal - discount) + shipping;

  // mirror items
  payImgK.src = order.keycap?.images?.[0] || order.keycap?.img || '';
  payImgS.src = order.switch?.img || '';
  payImgB.src = order.base?.images?.[0] || order.base?.img || '';
  payNameK.textContent = order.keycap?.desc || 'Кейкап';
  payNameS.textContent = order.switch?.desc || 'Свитч';
  payNameB.textContent = order.base?.desc || 'Основа';

  paySub.textContent = `${subtotal.toLocaleString('ru-RU')} ₽`;
  payDisc.textContent = `−${discount.toLocaleString('ru-RU')} ₽`;
  payRowDisc.style.display = discount>0 ? '' : 'none';
  payShip.textContent = `${shipping.toLocaleString('ru-RU')} ₽`;
  payAssembly.textContent = `0 ₽`;
  payTotal.textContent = `${total.toLocaleString('ru-RU')} ₽`;

  // methods + details
  const radios = payMethods.querySelectorAll('input[name="pay"]');
  radios.forEach(r => r.checked = (r.value === order.paymentMethod));
  updatePayDetails();

  payModal.style.display='flex'; payModal.setAttribute('aria-hidden','false');
}
function closePay(){ payModal.style.display='none'; payModal.setAttribute('aria-hidden','true'); }
payClose.addEventListener('click', closePay);
payMethods.addEventListener('change', updatePayDetails);
function updatePayDetails(){
  const sel = payMethods.querySelector('input[name="pay"]:checked');
  const v = sel ? sel.value : 'crypto';
  order.paymentMethod = v;
  persistDraft();
  let html = '';
  if(v === 'crypto'){
    html = '<b>Инструкция (криптовалюта)</b><div style="margin-top:6px">Выберите кошелёк и отправьте сумму. После оплаты нажмите «Оплатить и оформить». (демо)</div>';
  } else if(v === 'sbp'){
    html = '<b>Оплата через СБП</b><div style="margin-top:6px">Откроется ссылка на оплату. После оплаты нажмите «Оплатить и оформить».</div>';
  } else {
    html = '<b>Банковская карта</b><div style="margin-top:6px">Введите данные карты на защищённой странице (демо). После успешной оплаты заказ будет оформлен.</div>';
  }
  payDetails.style.display = 'block';
  payDetails.innerHTML = html;
}

confirmPay.addEventListener('click', ()=>{
  const subtotal = calcSubtotal(), discount = calcDiscount(subtotal), shipping = Number(order.deliveryCost||0);
  const total = Math.max(0, subtotal - discount) + shipping;
  const newOrder = {
    id: 'MZ-' + Date.now(),
    createdAt: new Date().toISOString(),
    items: { keycap: order.keycap, switch: order.switch, base: order.base },
    pricing: { subtotal, discount, shipping, assembly:0, total, promo: order.promoCode || null },
    payment: order.paymentMethod, status: 'Ожидает сборки', shipDate: null
  };
  const arr = loadOrders(); arr.unshift(newOrder); saveOrders(arr);
  // reset current basket
  order.keycap = order.switch = order.base = null;
  persistDraft(); updateOrderView(); closePay();
  // Switch to Orders tab to show result
  activateTab('orders');
});

/* ======================= ЗАКАЗЫ РЕНДЕР ======================= */
function renderOrders(){
  const list = loadOrders();
  ordersList.innerHTML = '';
  if(list.length === 0){
    ordersList.innerHTML = '<div class="muted" style="text-align:center">Пока нет заказов.</div>';
    return;
  }
  list.forEach(o=>{
    const el = document.createElement('div'); el.className='order';
    el.innerHTML = `
      <div class="order-head">
        <div><b>${escapeHtml(o.id)}</b> · <span class="muted">${new Date(o.createdAt).toLocaleString('ru-RU')}</span></div>
        <div style="background:#eafaf1;padding:6px 8px;border-radius:999px;border:1px solid #bfead6">${escapeHtml(o.status)}${o.shipDate?(' · отправка: '+new Date(o.shipDate).toLocaleDateString('ru-RU')):''}</div>
      </div>
      <div class="order-items">
        <img src="${o.items.keycap?.images?.[0] || o.items.keycap?.img || ''}">
        <img src="${o.items.switch?.img || ''}">
        <img src="${o.items.base?.images?.[0] || o.items.base?.img || ''}">
      </div>
      <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
        <div class="muted">Итого:</div>
        <div style="font-weight:900">${(o.pricing.total||0).toLocaleString('ru-RU')} ₽</div>
      </div>
    `;
    ordersList.appendChild(el);
  });
}

/* ======================= COMMUNITY RENDER ======================= */
const commTabs = document.querySelectorAll('.comm-btn');
const commContent = document.getElementById('community-content');

commTabs.forEach(b=> b.addEventListener('click', ()=>{
  commTabs.forEach(x=> x.classList.toggle('active', x===b));
  showCommunity(b.dataset.tab);
}));

function showCommunity(tab){
  commContent.innerHTML = '';
  if(tab==='keyboards'){
    const wrap = document.createElement('div'); wrap.className='posts';
    communityData.posts.forEach(p=>{
      const post = document.createElement('div'); post.className='post';
      post.innerHTML = `
        <div class="post-head"><div>${escapeHtml(p.title)}</div>
          <button class="more">⋯</button></div>
        <img class="post-img" src="${p.img}" alt="${escapeHtml(p.title)}"/>
        <div class="post-actions">
          <button class="like-btn ${p.liked?'liked':''}">Нравится</button>
          <div>${p.likes.toLocaleString('ru-RU')} ♥</div>
        </div>
      `;
      // like toggle (+1 / -1)
      const btn = post.querySelector('.like-btn');
      const counter = post.querySelector('.post-actions div');
      btn.addEventListener('click', ()=>{
        p.liked = !p.liked;
        if(p.liked){ p.likes += 1; btn.classList.add('liked'); }
        else{ p.likes = Math.max(0, p.likes-1); btn.classList.remove('liked'); }
        counter.textContent = `${p.likes.toLocaleString('ru-RU')} ♥`;
      });

      // 3-dots -> show components pop
      post.querySelector('.more').addEventListener('click', ()=>{
        const box = document.createElement('div');
        box.className='comp-pop';
        box.innerHTML = `<div style="font-weight:800;color:#145c48;margin-bottom:6px">Комплектующие</div>
        <div class="comp-grid">
          <div class="mini-slot"><img src="${p.items.keycap?.images?.[0] || p.items.keycap?.img || ''}"><div style="font-size:12px;margin-top:4px">${escapeHtml(p.items.keycap?.desc||'')}</div></div>
          <div class="mini-slot"><img src="${p.items.switch?.img || ''}"><div style="font-size:12px;margin-top:4px">${escapeHtml(p.items.switch?.desc||'')}</div></div>
          <div class="mini-slot"><img src="${p.items.base?.images?.[0] || p.items.base?.img || ''}"><div style="font-size:12px;margin-top:4px">${escapeHtml(p.items.base?.desc||'')}</div></div>
        </div>`;
        post.appendChild(box);
        post.querySelector('.more').disabled = true;
      });

      wrap.appendChild(post);
    });
    commContent.appendChild(wrap);
  } else {
    const list = document.createElement('div'); list.className='reviews-list';
    communityData.reviews.forEach(r=>{
      const card = document.createElement('div'); card.className='review';
      card.innerHTML = `
        <div class="review-head">
          <img class="review-img" src="${r.img}" alt="Клавиатура">
          <div><div class="stars">★ ${r.rating.toFixed(1)} / 5</div></div>
        </div>
        <div style="margin-top:8px">${escapeHtml(r.text)}</div>
      `;
      // click on image -> show components of related post
      const img = card.querySelector('.review-img');
      img.addEventListener('click', ()=>{
        const p = communityData.posts.find(x=>x.img===r.img);
        if(!p) return;
        openComponentsQuick(p);
      });
      list.appendChild(card);
    });
    const note = document.createElement('div'); note.className='muted'; note.style.marginTop='6px';
    note.textContent = 'Отзывы добавляются через @midzum7 в Telegram.';
    list.appendChild(note);

    commContent.appendChild(list);
  }
}

function openComponentsQuick(p){
  modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
  modalImg.src = p.img;
  modalPrice.textContent = 'Комплектующие';
  modalDesc.textContent = p.title;
  modalExtra.innerHTML = `
    <div style="display:flex;gap:10px;margin-top:6px">
      <div class="mini-slot"><img src="${p.items.keycap?.images?.[0] || p.items.keycap?.img || ''}"><div style="font-size:12px;margin-top:4px">${escapeHtml(p.items.keycap?.desc||'')}</div></div>
      <div class="mini-slot"><img src="${p.items.switch?.img || ''}"><div style="font-size:12px;margin-top:4px">${escapeHtml(p.items.switch?.desc||'')}</div></div>
      <div class="mini-slot"><img src="${p.items.base?.images?.[0] || p.items.base?.img || ''}"><div style="font-size:12px;margin-top:4px">${escapeHtml(p.items.base?.desc||'')}</div></div>
    </div>`;
  modalNav.style.display='none'; dots.innerHTML='';
  modalAddBtn.onclick = ()=>{};
}

/* ======================= ТАБЫ НИЖНЕЙ НАВИГАЦИИ ======================= */
tabConfig.addEventListener('click', ()=> activateTab('config'));
tabOrders.addEventListener('click', ()=> activateTab('orders'));
tabCommunity.addEventListener('click', ()=> activateTab('community'));

function activateTab(name){
  [tabConfig,tabOrders,tabCommunity].forEach(b=>b.classList.remove('active'));
  secConfigurator.classList.add('hidden');
  secOrders.classList.add('hidden');
  secCommunity.classList.add('hidden');

  if(name==='config'){
    tabConfig.classList.add('active');
    secConfigurator.classList.remove('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  } else if(name==='orders'){
    tabOrders.classList.add('active');
    secOrders.classList.remove('hidden');
    renderOrders();
    window.scrollTo({top:0,behavior:'smooth'});
  } else {
    tabCommunity.classList.add('active');
    secCommunity.classList.remove('hidden'); // FIXED: community now shows (no display:none class conflict)
    if(!secCommunity.dataset.inited){
      showCommunity('keyboards');
      secCommunity.dataset.inited='1';
    }
    window.scrollTo({top:0,behavior:'smooth'});
  }
}

/* ======================= ОБРАБОТЧИКИ ======================= */
deliverySelect.addEventListener('change', (e) => { order.deliveryCost = Number(e.target.value||0); persistDraft(); updateOrderView(); });
placeOrderBtn.addEventListener('click', openPay);
catBtns.forEach(b => b.addEventListener('click', ()=> renderGrid(b.dataset.cat)));

/* ======================= ТОПБАР ДИНАМИКА ======================= */
(function dynamicTopbar(){
  let lastY = 0;
  window.addEventListener('scroll', ()=>{
    const y = window.scrollY || 0;
    if(y>8 && lastY<=8) topLogo.classList.add('shrink');
    if(y<=8 && lastY>8) topLogo.classList.remove('shrink');
    lastY = y;
  }, {passive:true});
})();

/* ======================= INIT ======================= */
(function init(){
  renderGrid(currentCategory);
  updateOrderView();
})();

/* ======================= УТИЛЫ ======================= */
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
</script>
</body>
</html>
